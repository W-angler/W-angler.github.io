<!DOCTYPE html>
<html style="display: none;" lang="zh">
    <head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
    <!--
        © Material Theme
        https://github.com/viosey/hexo-theme-material
        Version: 1.5.6 -->
    <script>
        window.materialVersion = "1.5.6"
        // Delete localstorage with these tags
        window.oldVersion = [
            'codestartv1',
            '1.3.4',
            '1.4.0',
            '1.4.0b1',
            '1.5.0',
            '1.5.2',
            '1.5.5'
        ]
    </script>

    <!-- dns prefetch -->
    <meta http-equiv="x-dns-prefetch-control" content="on">

    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net/gh/viosey/hexo-theme-material@1.5.6/source/">





    <link rel="dns-prefetch" href="https://imsun.github.io">



    <link rel="dns-prefetch" href="https://www.google-analytics.com">



    <link rel="dns-prefetch" href="https://lib.baomitu.com">





    <!-- Meta & Info -->
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta name="renderer" content="webkit">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!-- Title -->
    
    <title>
        
            用一个printf()语句实现一个web服务器 | 
        
        年轻人啊不要熬夜
    </title>

    <!-- Favicons -->
    <link rel="icon shortcut" type="image/ico" href="/img/favicon.jpg">
    <link rel="icon" href="/img/favicon.jpg">

    <meta name="format-detection" content="telephone=no">
    <meta name="description" itemprop="description" content="">
    <meta name="keywords" content=",C,格式化字符串攻击,终止节,ELF,ShellCode">
    <meta name="theme-color" content="#0097A7">

    <!-- Disable Fucking Bloody Baidu Tranformation -->
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta http-equiv="Cache-Control" content="no-siteapp">

    <!--[if lte IE 9]>
        <link rel="stylesheet" href="/css/ie-blocker.css">

        
            <script src="/js/ie-blocker.zhCN.js"></script>
        
    <![endif]-->

    <!-- Import lsloader -->
    <script>(function(){window.lsloader={jsRunSequence:[],jsnamemap:{},cssnamemap:{}};lsloader.removeLS=function(a){try{localStorage.removeItem(a)}catch(b){}};lsloader.setLS=function(a,c){try{localStorage.setItem(a,c)}catch(b){}};lsloader.getLS=function(a){var c="";try{c=localStorage.getItem(a)}catch(b){c=""}return c};versionString="/*"+(window.materialVersion||"unknownVersion")+"*/";lsloader.clean=function(){try{var b=[];for(var a=0;a<localStorage.length;a++){b.push(localStorage.key(a))}b.forEach(function(e){var f=lsloader.getLS(e);if(window.oldVersion){var d=window.oldVersion.reduce(function(g,h){return g||f.indexOf("/*"+h+"*/")!==-1},false);if(d){lsloader.removeLS(e)}}})}catch(c){}};lsloader.clean();lsloader.load=function(f,a,b,d){if(typeof b==="boolean"){d=b;b=undefined}d=d||false;b=b||function(){};var e;e=this.getLS(f);if(e&&e.indexOf(versionString)===-1){this.removeLS(f);this.requestResource(f,a,b,d);return}if(e){var c=e.split(versionString)[0];if(c!=a){console.log("reload:"+a);this.removeLS(f);this.requestResource(f,a,b,d);return}e=e.split(versionString)[1];if(d){this.jsRunSequence.push({name:f,code:e});this.runjs(a,f,e)}else{document.getElementById(f).appendChild(document.createTextNode(e));b()}}else{this.requestResource(f,a,b,d)}};lsloader.requestResource=function(b,e,a,c){var d=this;if(c){this.iojs(e,b,function(h,f,g){d.setLS(f,h+versionString+g);d.runjs(h,f,g)})}else{this.iocss(e,b,function(f){document.getElementById(b).appendChild(document.createTextNode(f));d.setLS(b,e+versionString+f)},a)}};lsloader.iojs=function(d,b,g){var a=this;a.jsRunSequence.push({name:b,code:""});try{var f=new XMLHttpRequest();f.open("get",d,true);f.onreadystatechange=function(){if(f.readyState==4){if((f.status>=200&&f.status<300)||f.status==304){if(f.response!=""){g(d,b,f.response);return}}a.jsfallback(d,b)}};f.send(null)}catch(c){a.jsfallback(d,b)}};lsloader.iocss=function(f,c,h,a){var b=this;try{var g=new XMLHttpRequest();g.open("get",f,true);g.onreadystatechange=function(){if(g.readyState==4){if((g.status>=200&&g.status<300)||g.status==304){if(g.response!=""){h(g.response);a();return}}b.cssfallback(f,c,a)}};g.send(null)}catch(d){b.cssfallback(f,c,a)}};lsloader.iofonts=function(f,c,h,a){var b=this;try{var g=new XMLHttpRequest();g.open("get",f,true);g.onreadystatechange=function(){if(g.readyState==4){if((g.status>=200&&g.status<300)||g.status==304){if(g.response!=""){h(g.response);a();return}}b.cssfallback(f,c,a)}};g.send(null)}catch(d){b.cssfallback(f,c,a)}};lsloader.runjs=function(f,c,e){if(!!c&&!!e){for(var b in this.jsRunSequence){if(this.jsRunSequence[b].name==c){this.jsRunSequence[b].code=e}}}if(!!this.jsRunSequence[0]&&!!this.jsRunSequence[0].code&&this.jsRunSequence[0].status!="failed"){var a=document.createElement("script");a.appendChild(document.createTextNode(this.jsRunSequence[0].code));a.type="text/javascript";document.getElementsByTagName("head")[0].appendChild(a);this.jsRunSequence.shift();if(this.jsRunSequence.length>0){this.runjs()}}else{if(!!this.jsRunSequence[0]&&this.jsRunSequence[0].status=="failed"){var d=this;var a=document.createElement("script");a.src=this.jsRunSequence[0].path;a.type="text/javascript";this.jsRunSequence[0].status="loading";a.onload=function(){d.jsRunSequence.shift();if(d.jsRunSequence.length>0){d.runjs()}};document.body.appendChild(a)}}};lsloader.tagLoad=function(b,a){this.jsRunSequence.push({name:a,code:"",path:b,status:"failed"});this.runjs()};lsloader.jsfallback=function(c,b){if(!!this.jsnamemap[b]){return}else{this.jsnamemap[b]=b}for(var a in this.jsRunSequence){if(this.jsRunSequence[a].name==b){this.jsRunSequence[a].code="";this.jsRunSequence[a].status="failed";this.jsRunSequence[a].path=c}}this.runjs()};lsloader.cssfallback=function(e,c,b){if(!!this.cssnamemap[c]){return}else{this.cssnamemap[c]=1}var d=document.createElement("link");d.type="text/css";d.href=e;d.rel="stylesheet";d.onload=d.onerror=b;var a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(d,a)};lsloader.runInlineScript=function(c,b){var a=document.getElementById(b).innerText;this.jsRunSequence.push({name:c,code:a});this.runjs()}})();</script>

    <!-- Import queue -->
    <script>function Queue(){this.dataStore=[];this.offer=b;this.poll=d;this.execNext=a;this.debug=false;this.startDebug=c;function b(e){if(this.debug){console.log("Offered a Queued Function.")}if(typeof e==="function"){this.dataStore.push(e)}else{console.log("You must offer a function.")}}function d(){if(this.debug){console.log("Polled a Queued Function.")}return this.dataStore.shift()}function a(){var e=this.poll();if(e!==undefined){if(this.debug){console.log("Run a Queued Function.")}e()}}function c(){this.debug=true}}var queue=new Queue();</script>

    <!-- Import CSS -->
    
        <style id="material_css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("material_css","https://cdn.jsdelivr.net/gh/viosey/hexo-theme-material@1.5.6/source//css/material.min.css",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>
        <style id="style_css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("style_css","https://cdn.jsdelivr.net/gh/viosey/hexo-theme-material@1.5.6/source//css/style.min.css",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>

        
            
                <style id="prettify_css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("prettify_css","https://cdn.jsdelivr.net/gh/viosey/hexo-theme-material@1.5.6/source//css/prettify.min.css",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>
                <style id="prettify_theme"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("prettify_theme","https://cdn.jsdelivr.net/gh/viosey/hexo-theme-material@1.5.6/source//css/prettify/tomorrow-night-eighties.min.css",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>
            
        

    

    

    <!-- Config CSS -->

<!-- Other Styles -->
<style>
  body, html {
    font-family: Roboto, "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "微软雅黑", Arial, sans-serif;
    overflow-x: hidden !important;
  }
  
  code {
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
  }

  a {
    color: #00838F;
  }

  .mdl-card__media,
  #search-label,
  #search-form-label:after,
  #scheme-Paradox .hot_tags-count,
  #scheme-Paradox .sidebar_archives-count,
  #scheme-Paradox .sidebar-colored .sidebar-header,
  #scheme-Paradox .sidebar-colored .sidebar-badge{
    background-color: #0097A7 !important;
  }

  /* Sidebar User Drop Down Menu Text Color */
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:hover,
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:focus {
    color: #0097A7 !important;
  }

  #post_entry-right-info,
  .sidebar-colored .sidebar-nav li:hover > a,
  .sidebar-colored .sidebar-nav li:hover > a i,
  .sidebar-colored .sidebar-nav li > a:hover,
  .sidebar-colored .sidebar-nav li > a:hover i,
  .sidebar-colored .sidebar-nav li > a:focus i,
  .sidebar-colored .sidebar-nav > .open > a,
  .sidebar-colored .sidebar-nav > .open > a:hover,
  .sidebar-colored .sidebar-nav > .open > a:focus,
  #ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a {
    color: #0097A7 !important;
  }

  .toTop {
    background: #757575 !important;
  }

  .material-layout .material-post>.material-nav,
  .material-layout .material-index>.material-nav,
  .material-nav a {
    color: #757575;
  }

  #scheme-Paradox .MD-burger-layer {
    background-color: #757575;
  }

  #scheme-Paradox #post-toc-trigger-btn {
    color: #757575;
  }

  .post-toc a:hover {
    color: #00838F;
    text-decoration: underline;
  }

</style>


<!-- Theme Background Related-->

    <style>
      body{
        background-color: #F5F5F5;
      }

      /* blog_info bottom background */
      #scheme-Paradox .material-layout .something-else .mdl-card__supporting-text{
        background-color: #fff;
      }
    </style>




<!-- Fade Effect -->

    <style>
      .fade {
        transition: all 800ms linear;
        -webkit-transform: translate3d(0,0,0);
        -moz-transform: translate3d(0,0,0);
        -ms-transform: translate3d(0,0,0);
        -o-transform: translate3d(0,0,0);
        transform: translate3d(0,0,0);
        opacity: 1;
      }

      .fade.out{
        opacity: 0;
      }
    </style>


<!-- Import Font -->
<!-- Import Roboto -->

    <style>
        @font-face {
            font-family: Roboto;
            font-style: normal;
            font-weight: 300;
            src: url(https://lib.baomitu.com/fonts/roboto/roboto-v15-latin-300.eot);
            src: local('Roboto'),local('Roboto-Normal'),url(https://lib.baomitu.com/fonts/roboto/roboto-v15-latin-300.eot?#iefix) format('embedded-opentype'),url(https://lib.baomitu.com/fonts/roboto/roboto-v15-latin-300.woff2) format('woff2'),url(https://lib.baomitu.com/fonts/roboto/roboto-v15-latin-300.woff) format('woff'),url(https://lib.baomitu.com/fonts/roboto/roboto-v15-latin-300.ttf) format('truetype'),url(https://lib.baomitu.com/fonts/roboto/roboto-v15-latin-300.svg#Roboto) format('svg')
        }

        @font-face {
            font-family: Roboto;
            font-style: normal;
            font-weight: regular;
            src: url(https://lib.baomitu.com/fonts/roboto/roboto-v15-latin-regular.eot);
            src: local('Roboto'),local('Roboto-Normal'),url(https://lib.baomitu.com/fonts/roboto/roboto-v15-latin-regular.eot?#iefix) format('embedded-opentype'),url(https://lib.baomitu.com/fonts/roboto/roboto-v15-latin-regular.woff2) format('woff2'),url(https://lib.baomitu.com/fonts/roboto/roboto-v15-latin-regular.woff) format('woff'),url(https://lib.baomitu.com/fonts/roboto/roboto-v15-latin-regular.ttf) format('truetype'),url(https://lib.baomitu.com/fonts/roboto/roboto-v15-latin-regular.svg#Roboto) format('svg')
        }

        @font-face {
            font-family: Roboto;
            font-style: normal;
            font-weight: 500;
            src: url(https://lib.baomitu.com/fonts/roboto/roboto-v15-latin-500.eot);
            src: local('Roboto'),local('Roboto-Normal'),url(https://lib.baomitu.com/fonts/roboto/roboto-v15-latin-500.eot?#iefix) format('embedded-opentype'),url(https://lib.baomitu.com/fonts/roboto/roboto-v15-latin-500.woff2) format('woff2'),url(https://lib.baomitu.com/fonts/roboto/roboto-v15-latin-500.woff) format('woff'),url(https://lib.baomitu.com/fonts/roboto/roboto-v15-latin-500.ttf) format('truetype'),url(https://lib.baomitu.com/fonts/roboto/roboto-v15-latin-500.svg#Roboto) format('svg')
        }
    </style>


<!-- Import Material Icons -->


    <style id="material_icons"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("material_icons","https://cdn.jsdelivr.net/gh/viosey/hexo-theme-material@1.5.6/source//css/material-icons.css",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>




    <!-- Import jQuery -->
    
        <script>lsloader.load("jq_js","https://cdn.bootcss.com/jquery/2.2.0/jquery.min.js", true)</script>
    

    <!-- WebAPP Icons -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="年轻人啊不要熬夜">
    <meta name="msapplication-starturl" content="https://w-angler.com/2016/12/05/用一个printf-语句实现一个web服务器/">
    <meta name="msapplication-navbutton-color" content="#0097A7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="年轻人啊不要熬夜">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon" href="/img/favicon.jpg">

    <!-- Site Verification -->
    
    

    <!-- RSS -->
    
        
            <link rel="alternate" type="application/atom+xml" href="/atom.xml">
        
    

    <!-- The Open Graph protocol -->
    <meta property="og:url" content="https://w-angler.com/2016/12/05/用一个printf-语句实现一个web服务器/">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="用一个printf()语句实现一个web服务器 | 年轻人啊不要熬夜">
    <meta property="og:image" content="/img/favicon.jpg">
    <meta property="og:description" content="">
    <meta property="og:article:tag" content="C"> <meta property="og:article:tag" content="格式化字符串攻击"> <meta property="og:article:tag" content="终止节"> <meta property="og:article:tag" content="ELF"> <meta property="og:article:tag" content="ShellCode"> 

    
        <meta property="article:published_time" content="Mon Dec 05 2016 16:01:30 GMT+0800">
        <meta property="article:modified_time" content="Sun Apr 01 2018 18:16:18 GMT+0800">
    

    <!-- The Twitter Card protocol -->
    <meta name="twitter:card" content="summary_large_image">

    <!-- Add canonical link for SEO -->
    
        <link rel="canonical" href="https://w-angler.com/2016/12/05/用一个printf-语句实现一个web服务器/index.html">
    

    <!-- Structured-data for SEO -->
    
        


<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage": "https://w-angler.com/2016/12/05/用一个printf-语句实现一个web服务器/index.html",
    "headline": "用一个printf()语句实现一个web服务器",
    "datePublished": "Mon Dec 05 2016 16:01:30 GMT+0800",
    "dateModified": "Sun Apr 01 2018 18:16:18 GMT+0800",
    "author": {
        "@type": "Person",
        "name": "W-angler",
        "image": {
            "@type": "ImageObject",
            "url": "/img/avatar.jpg"
        },
        "description": "A monad is just a monoid in the category of endofunctors, what's the problem?"
    },
    "publisher": {
        "@type": "Organization",
        "name": "年轻人啊不要熬夜",
        "logo": {
            "@type":"ImageObject",
            "url": "/img/favicon.jpg"
        }
    },
    "keywords": ",C,格式化字符串攻击,终止节,ELF,ShellCode",
    "description": "",
}
</script>


    

    <!-- Analytics -->
    
        <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-89109775-1', 'auto');ga('send', 'pageview');
</script>
    
    
    

    <!-- Custom Head -->
    

</head>


    
        <body id="scheme-Paradox" class="lazy">
            <div class="material-layout  mdl-js-layout has-drawer is-upgraded">
                

                <!-- Main Container -->
                <main class="material-layout__content" id="main">

                    <!-- Top Anchor -->
                    <div id="top"></div>

                    
                        <!-- Hamburger Button -->
                        <button class="MD-burger-icon sidebar-toggle">
                            <span id="MD-burger-id" class="MD-burger-layer"></span>
                        </button>
                    

                    <!-- Post TOC -->

    
    <!-- Back Button -->
    <!--
    <div class="material-back" id="backhome-div" tabindex="0">
        <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon"
           href="#" onclick="window.history.back();return false;"
           target="_self"
           role="button"
           data-upgraded=",MaterialButton,MaterialRipple">
            <i class="material-icons" role="presentation">arrow_back</i>
            <span class="mdl-button__ripple-container">
                <span class="mdl-ripple"></span>
            </span>
        </a>
    </div>
    -->


    <!-- Left aligned menu below button -->
    
    
    <button id="post-toc-trigger-btn" class="mdl-button mdl-js-button mdl-button--icon">
        <i class="material-icons">format_list_numbered</i>
    </button>

    <ul class="post-toc-wrap mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect" for="post-toc-trigger-btn" style="max-height:80vh; overflow-y:scroll;">
        <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#正文"><span class="post-toc-number">1.</span> <span class="post-toc-text">正文</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#写在后面"><span class="post-toc-number">2.</span> <span class="post-toc-text">写在后面</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#补充"><span class="post-toc-number">3.</span> <span class="post-toc-text">补充</span></a></li></ol>
    </ul>
    




<!-- Layouts -->

    <!-- Post Module -->
    <div class="material-post_container">

        <div class="material-post mdl-grid">
            <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">

                <!-- Post Header(Thumbnail & Title) -->
                
    <!-- Paradox Post Header -->
    
        
            <!-- Random Thumbnail -->
            <div class="post_thumbnail-random mdl-card__media mdl-color-text--grey-50">
            <script type="text/ls-javascript" id="post-thumbnail-script">
    var randomNum = Math.floor(Math.random() * 19 + 1);

    $('.post_thumbnail-random').attr('data-original', '/img/random/material-' + randomNum + '.png');
    $('.post_thumbnail-random').addClass('lazy');
</script>

        
    
            <p class="article-headline-p">
                用一个printf()语句实现一个web服务器
            </p>
        </div>





                
                    <!-- Paradox Post Info -->
                    <div class="mdl-color-text--grey-700 mdl-card__supporting-text meta">

    <!-- Author Avatar -->
    <div id="author-avatar">
        <img src="/img/avatar.jpg" width="44px" height="44px" alt="Author Avatar">
    </div>
    <!-- Author Name & Date -->
    <div>
        <strong>W-angler</strong>
        <span>12月 05, 2016</span>
    </div>

    <div class="section-spacer"></div>

    <!-- Favorite -->
    <!--
        <button id="article-functions-like-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon btn-like">
            <i class="material-icons" role="presentation">favorite</i>
            <span class="visuallyhidden">favorites</span>
        </button>
    -->

    <!-- Qrcode -->
    
        <button id="article-functions-qrcode-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
    <i class="material-icons" role="presentation">devices other</i>
    <span class="visuallyhidden">devices other</span>
</button>
<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-functions-qrcode-button">
    <li class="mdl-menu__item">在其它设备中阅读本文章</li>
    
        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQ4AAAEOCAAAAABd2qZ5AAADmElEQVR42u3aQW4jMQwEwPz/09lrgF3b3aTkeIHSKUjGk1HNgWaLX9/Wj/WFAAcOHDhw4MCBAweOD+b4itejTz36zfP7//zr858f3ecfG5vtBQcOHDhwXOB4UYqCf/9oS8/h8s8+AtrvBQcOHDhw3OPYP2hbIGdbff568r3gwIEDB47P4cgLcL6xFiu5Mw4cOHDg+F84NmU4jxqft2GbBhIHDhw4cLyHIwnU8uvzdq4tvR+UleLAgQMHjvVAw+f//Nb5Dhw4cODA8RdHu5IBhfyoKR+A+762cODAgQPHWY58Y5sHzUPDGeXs+XHgwIEDxz2OWeR3Nv5rY8Fiw7OOFgcOHDhwLDiS7RUHOQviZIRiduXwewcOHDhw4Bhx5EUrL71tE5hcOVsv6HHgwIEDxwWO5EHzDbS/mQ0lHGs7ceDAgQPHBY4k1GtjuyiYi0O92VFW1C7iwIEDB46jHElZyscLZpFfPqDQvoAoAMWBAwcOHEc5Ns1VsvnnjzK7wyaOLE7hcODAgQPHiKM9CspH1tpDoM0xUtt24sCBAweO2xztEU5bMtv/0kaB7TU4cODAgeMex6Zhy9u59p7taEX7FQEHDhw4cNzj2BTCWRi3Kbr5kVICgQMHDhw43smRj51tBuOSputs+4cDBw4cOG5ztBtoY7v8njO+dvQhCgdx4MCBA8eCo33QYZsURJBtcc1jxBevEwcOHDhwXOZoB+P2pXQzVH3giwIOHDhw4LjAMQv78mK5GXSLhhI2ZDhw4MCB4yhH2z4lm3neVu1H3/JnGGalOHDgwIFjzbEZg25HsfPocMb0XS4cOHDgwPEejs0oQwuaHzK1bV4dDuLAgQMHjkMcm8Oh2QBE8qlNFFh8jcCBAwcOHJc52iCvLZB5KNkehg3HL3DgwIEDx9s5Zsc/syKdX5O8PBw4cODA8bscs0dv27BZe7Ypui8aVBw4cODAcZljFrHN2r/8DrOCmjDhwIEDB46zHO1KCnNSJmdlOG/2cODAgQPHb3G0hSrZ9qbpSsp5OyT34m44cODAgeMCxz7yexHAjSK/duSibU1x4MCBA8dtjnYEbXbwk8C17Vn7FQEHDhw4cHwaxywoTJq3NgRsy2rRwuHAgQMHjrdznDpYOtsi5oMXOHDgwIHjNsd+aKAdRJg1XXnpjV4kDhw4cOC4wJFHbGfDu3Yb7QhFVLZx4MCBA8dRDgsHDhw4cODAgQMHDhwftv4A/umlTixk5zkAAAAASUVORK5CYII=">
    
</ul>

    

    <!-- Tags (bookmark) -->
    
    <button id="article-functions-viewtags-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
        <i class="material-icons" role="presentation">bookmark</i>
        <span class="visuallyhidden">bookmark</span>
    </button>
    <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-functions-viewtags-button">
        <li class="mdl-menu__item">
        <a class="post_tag-link" href="/tags/C/">C</a></li><li class="mdl-menu__item"><a class="post_tag-link" href="/tags/ELF/">ELF</a></li><li class="mdl-menu__item"><a class="post_tag-link" href="/tags/ShellCode/">ShellCode</a></li><li class="mdl-menu__item"><a class="post_tag-link" href="/tags/格式化字符串攻击/">格式化字符串攻击</a></li><li class="mdl-menu__item"><a class="post_tag-link" href="/tags/终止节/">终止节</a>
    </li></ul>
    

    <!-- Share -->
    
        <button id="article-fuctions-share-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
    <i class="material-icons" role="presentation">share</i>
    <span class="visuallyhidden">share</span>
</button>
<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-fuctions-share-button">
    

    

    <!-- Share Weibo -->
    
        <a class="post_share-link" href="http://service.weibo.com/share/share.php?appkey=&title=用一个printf()语句实现一个web服务器&url=https://w-angler.com/2016/12/05/用一个printf-语句实现一个web服务器/index.html&pic=https://w-angler.com/img/favicon.jpg&searchPic=false&style=simple" target="_blank">
            <li class="mdl-menu__item">
                分享到微博
            </li>
        </a>
    

    <!-- Share Twitter -->
    
        <a class="post_share-link" href="https://twitter.com/intent/tweet?text=用一个printf()语句实现一个web服务器&url=https://w-angler.com/2016/12/05/用一个printf-语句实现一个web服务器/index.html&via=W-angler" target="_blank">
            <li class="mdl-menu__item">
                分享到 Twitter
            </li>
        </a>
    

    <!-- Share Facebook -->
    
        <a class="post_share-link" href="https://www.facebook.com/sharer/sharer.php?u=https://w-angler.com/2016/12/05/用一个printf-语句实现一个web服务器/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Facebook
            </li>
        </a>
    

    <!-- Share Google+ -->
    
        <a class="post_share-link" href="https://plus.google.com/share?url=https://w-angler.com/2016/12/05/用一个printf-语句实现一个web服务器/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Google+
            </li>
        </a>
    

    <!-- Share LinkedIn -->
    
        <a class="post_share-link" href="https://www.linkedin.com/shareArticle?mini=true&url=https://w-angler.com/2016/12/05/用一个printf-语句实现一个web服务器/index.html&title=用一个printf()语句实现一个web服务器" target="_blank">
            <li class="mdl-menu__item">
                分享到 LinkedIn
            </li>
        </a>
    

    <!-- Share QQ -->
    
        <a class="post_share-link" href="http://connect.qq.com/widget/shareqq/index.html?site=年轻人啊不要熬夜&title=用一个printf()语句实现一个web服务器&summary=&pics=https://w-angler.com/img/favicon.jpg&url=https://w-angler.com/2016/12/05/用一个printf-语句实现一个web服务器/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 QQ
            </li>
        </a>
    

    <!-- Share Telegram -->
    
        <a class="post_share-link" href="https://telegram.me/share/url?url=https://w-angler.com/2016/12/05/用一个printf-语句实现一个web服务器/index.html&text=用一个printf()语句实现一个web服务器" target="_blank">
            <li class="mdl-menu__item">
                分享到 Telegram
            </li>
        </a>
    
</ul>

    
</div>

                

                <!-- Post Content -->
                <div id="post-content" class="mdl-color-text--grey-700 mdl-card__supporting-text fade out">
    
        <p>　　有这么一个笑话：<code>Jeff Dean</code>有一次用一句printf实现了一个web服务器。其他工程师添加了数千行注释但依然无法完全解释清楚其工作原理。而这个程序就是今天Google首页的前端。</p>
<p>　　而理论上，这个其实是可行的。</p>
<p>　　翻译原文：<a href="http://tinyhack.com/2014/03/12/implementing-a-web-server-in-a-single-printf-call/" target="_blank" rel="noopener">Implementing a web server in a single printf() call</a></p>
<h1 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h1><p>　　有人刚才给我转发了一个关于<code>Jeff Dean</code>的笑话——所谓的“关于Jeff Dean的事实”（链接：<a href="https://www.zhihu.com/question/20034686/answer/20646787" target="_blank" rel="noopener">知乎</a>，<a href="https://www.quora.com/Jeff-Dean/What-are-all-the-Jeff-Dean-facts" target="_blank" rel="noopener">quora</a>），每次我看这个时，下面这条总是很突出：</p>
<blockquote>
<p>Jeff Dean有一次用一句printf实现了一个web服务器。其他工程师添加了数千行注释但依然无法完全解释清楚其工作原理。而这个程序就是今天Google首页的前端。</p>
</blockquote>
<p>　　事实上，确实可以通过一句<code>printf</code>语句来实现一个web服务器，但我发现没有人做过这个。所以这次，我决定自己实现一下。下面就是实现的代码，只有单独的一句<code>printf</code>调用，没有额外的变量或者宏定义（别担心，我会解释它是怎么工作的）：</p>
<p><code>web1.c</code></p>
<pre><code>#include &lt;stdio.h&gt;
int main(int argc, char *argv[]){
    printf(&quot;%*c%hn%*c%hn&quot; 
    &quot;\xeb\x3d\x48\x54\x54\x50\x2f\x31\x2e\x30\x20\x32&quot; 
    &quot;\x30\x30\x0d\x0a\x43\x6f\x6e\x74\x65\x6e\x74\x2d&quot; 
    &quot;\x74\x79\x70\x65\x3a\x74\x65\x78\x74\x2f\x68\x74&quot; 
    &quot;\x6d\x6c\x0d\x0a\x0d\x0a\x3c\x68\x31\x3e\x48\x65&quot; 
    &quot;\x6c\x6c\x6f\x20\x57\x6f\x72\x6c\x64\x21\x3c\x2f&quot; 
    &quot;\x68\x31\x3e\x4c\x8d\x2d\xbc\xff\xff\xff\x48\x89&quot; 
    &quot;\xe3\x48\x83\xeb\x10\x48\x31\xc0\x50\x66\xb8\x1f&quot; 
    &quot;\x90\xc1\xe0\x10\xb0\x02\x50\x31\xd2\x31\xf6\xff&quot; 
    &quot;\xc6\x89\xf7\xff\xc7\x31\xc0\xb0\x29\x0f\x05\x49&quot; 
    &quot;\x89\xc2\x31\xd2\xb2\x10\x48\x89\xde\x89\xc7\x31&quot; 
    &quot;\xc0\xb0\x31\x0f\x05\x31\xc0\xb0\x05\x89\xc6\x4c&quot; 
    &quot;\x89\xd0\x89\xc7\x31\xc0\xb0\x32\x0f\x05\x31\xd2&quot; 
    &quot;\x31\xf6\x4c\x89\xd0\x89\xc7\x31\xc0\xb0\x2b\x0f&quot; 
    &quot;\x05\x49\x89\xc4\x48\x31\xd2\xb2\x3d\x4c\x89\xee&quot; 
    &quot;\x4c\x89\xe7\x31\xc0\xff\xc0\x0f\x05\x31\xf6\xff&quot; 
    &quot;\xc6\xff\xc6\x4c\x89\xe7\x31\xc0\xb0\x30\x0f\x05&quot; 
    &quot;\x4c\x89\xe7\x31\xc0\xb0\x03\x0f\x05\xeb\xc3&quot;,
    ((((unsigned long int)0x4005c8+12)&gt;&gt;16)&amp;0xffff),
    0,0x00000000006007D8+2,
    (((unsigned long int)0x4005c8+12)&amp;0xffff)-((((unsigned long int)0x4005c8+12)&gt;&gt;16)&amp;0xffff),
    0, 0x00000000006007D8 );
}
</code></pre><p>　　这段代码只能在64位的linux系统上运行（可能还和gcc的版本有关）。下面编译它：</p>
<pre><code>gcc -g web1.c -o webserver
</code></pre><p>　　你们可能已经猜到了，我使用了一段特殊的格式化字符串欺骗了你们。这段代码可能并不能在你的机器上运行，因为我硬编码了两个内存地址。</p>
<p>　　下面这个版本可能更明了一些（也容易修改一些），但是你依然需要改变两个值（后面我会解释）：<code>FUNCTION_ADDR</code>和<code>DESTADDR</code>。</p>
<pre><code>#include&lt;stdio.h&gt;
#include&lt;stdlib.h&gt;
#include&lt;stdint.h&gt;
#define FUNCTION_ADDR ((uint64_t)0x4005c8 + 12)
#define DESTADDR 0x00000000006007D8
#define a (FUNCTION_ADDR &amp; 0xffff)
#define b ((FUNCTION_ADDR &gt;&gt; 16) &amp; 0xffff)
int main(int argc, char *argv[]){
    printf(&quot;%*c%hn%*c%hn&quot; 
    &quot;\xeb\x3d\x48\x54\x54\x50\x2f\x31\x2e\x30\x20\x32&quot; 
    &quot;\x30\x30\x0d\x0a\x43\x6f\x6e\x74\x65\x6e\x74\x2d&quot; 
    &quot;\x74\x79\x70\x65\x3a\x74\x65\x78\x74\x2f\x68\x74&quot; 
    &quot;\x6d\x6c\x0d\x0a\x0d\x0a\x3c\x68\x31\x3e\x48\x65&quot; 
    &quot;\x6c\x6c\x6f\x20\x57\x6f\x72\x6c\x64\x21\x3c\x2f&quot; 
    &quot;\x68\x31\x3e\x4c\x8d\x2d\xbc\xff\xff\xff\x48\x89&quot; 
    &quot;\xe3\x48\x83\xeb\x10\x48\x31\xc0\x50\x66\xb8\x1f&quot; 
    &quot;\x90\xc1\xe0\x10\xb0\x02\x50\x31\xd2\x31\xf6\xff&quot; 
    &quot;\xc6\x89\xf7\xff\xc7\x31\xc0\xb0\x29\x0f\x05\x49&quot; 
    &quot;\x89\xc2\x31\xd2\xb2\x10\x48\x89\xde\x89\xc7\x31&quot; 
    &quot;\xc0\xb0\x31\x0f\x05\x31\xc0\xb0\x05\x89\xc6\x4c&quot; 
    &quot;\x89\xd0\x89\xc7\x31\xc0\xb0\x32\x0f\x05\x31\xd2&quot; 
    &quot;\x31\xf6\x4c\x89\xd0\x89\xc7\x31\xc0\xb0\x2b\x0f&quot; 
    &quot;\x05\x49\x89\xc4\x48\x31\xd2\xb2\x3d\x4c\x89\xee&quot; 
    &quot;\x4c\x89\xe7\x31\xc0\xff\xc0\x0f\x05\x31\xf6\xff&quot; 
    &quot;\xc6\xff\xc6\x4c\x89\xe7\x31\xc0\xb0\x30\x0f\x05&quot; 
    &quot;\x4c\x89\xe7\x31\xc0\xb0\x03\x0f\x05\xeb\xc3&quot;,
    b, 0, DESTADDR + 2, a-b, 0, DESTADDR );
}
</code></pre><p>　　我会通过下面这些简短的C代码解释上面的是怎样工作的。</p>
<p>　　第一个，我们如何不通过显式的函数调用来运行另一段代码？下面是一个例子：</p>
<p><code>run-finalizer.c</code></p>
<pre><code>#include&lt;stdlib.h&gt;
#include&lt;stdio.h&gt;
#define ADDR 0x00000000600720
void hello(){
    printf(&quot;hello world\n&quot;);
}
int main(int argc, char *argv[]){
    (*((unsigned long int*)ADDR))=(unsigned long int)hello;
}
</code></pre><p>　　你可以编译它，但是它可能并不能在你的系统上运行（会出现段错误），你需要按照以下的步骤来：</p>
<hr>
<p><strong>注：</strong></p>
<p>Ubuntu添加了一个在最终的<a href="http://baike.baidu.com/subview/1090277/10973487.htm#viewPageContent" target="_blank" rel="noopener">ELF</a>中提供只读的重定位表的安全机制。为了能够在ubuntu上运行这些例子，在编译时需要添加以下这些参数：</p>
<blockquote>
<p><code>-Wl,-z,norelro</code></p>
</blockquote>
<p>例如：</p>
<blockquote>
<p><code>gcc -Wl,-z,norelro test.c</code></p>
</blockquote>
<hr>
<p>　　1、编译这段代码：</p>
<pre><code>gcc run-finalizer.c -o run-finalizer
</code></pre><p>　　2、查看<code>.fini_array</code>（译者注：相关资料，<a href="http://docs.oracle.com/cd/E19253-01/819-7050/chapter3-1/" target="_blank" rel="noopener">链接程序和库指南</a>，<a href="http://docs.oracle.com/cd/E19253-01/819-7050/6n918j8mn/index.html#chapter2-48195" target="_blank" rel="noopener">初始化和终止节</a>，<a href="http://stackoverflow.com/questions/26292964/when-will-the-fini-array-section-being-used" target="_blank" rel="noopener">When will the .fini_array section being used?</a>）的地址：</p>
<pre><code>objdump -h -j .fini_array run-finalizer
</code></pre><p>　　然后找到<code>VMA</code>（Virtual Memory Area，虚拟内存空间）的地址：</p>
<pre><code>run-finalizer：     文件格式 elf64-x86-64
节：
Idx Name          Size      VMA               LMA               File off  Algn
19 .fini_array   00000008  00000000006007d8  00000000006007d8  000007d8  2**3
                 CONTENTS, ALLOC, LOAD, DATA
</code></pre><p>　　你最好使用最新版本的GCC来编译，老版本使用不同的机制来存储<code>终止例程</code>（资料：<a href="http://docs.oracle.com/cd/E19253-01/819-7050/6n918j8n2/index.html" target="_blank" rel="noopener">初始化和终止例程</a>）。</p>
<p>　　3、将<code>ADDR</code>改为<code>VMA</code>的值；</p>
<p>　　4、再次编译；</p>
<p>　　5、运行。</p>
<p>　　然后你应该可以看到在屏幕上打印出了”hello world”。</p>
<p>　　那它到底是怎么实现的呢？</p>
<p>　　根据<a href="http://refspecs.linuxbase.org/LSB_3.1.1/LSB-Core-generic/LSB-Core-generic/specialsections.html" target="_blank" rel="noopener">Chapter 11 of Linux Standard Base Core Specification 3.1</a>：</p>
<blockquote>
<p>.fini_array 这个节包含了一个函数指针数组，在含有这个部分的可执行文件或者共享对象中作为一个单独的终止函数数组（termination array）。</p>
</blockquote>
<blockquote>
<p>This section holds an array of function pointers that contributes to a single termination array for the executable or shared object containing the section.</p>
</blockquote>
<p>　　我们强制覆盖这个数组，这样<code>hello</code>函数就可以被调用了。如果你要编译上面的web服务器的代码，<code>ADDR</code>的值需要用同样方法来修改（使用<code>objdump</code>）。</p>
<p>　　现在我们知道如何通过覆盖某一个特定的地址来执行一个函数，接下来我们需要知道的是，如何使用<code>printf</code>来覆盖这个地址。你可以找到很多关于<code>格式化字符串攻击</code>的教程，在这里我试着做一个简短的解释。</p>
<hr>
<p>注：<code>格式化字符串攻击</code>（漏洞），是一种很古老的漏洞。可以查看下面的博客了解一下：</p>
<ul>
<li><a href="http://www.tuicool.com/articles/IniyYzA" target="_blank" rel="noopener">漏洞挖掘基础之格式化字符串</a></li>
<li><a href="http://www.freebuf.com/articles/system/74224.html" target="_blank" rel="noopener">格式化字符串的漏洞利用</a></li>
<li><a href="http://blog.csdn.net/immcss/article/details/6267849" target="_blank" rel="noopener">格式化字符串攻击原理及示例 </a></li>
</ul>
<hr>
<p>　　<code>printf</code>函数可以通过<code>%n</code>这个格式化字符来获取我们已经输出了多少个字符，例如：</p>
<pre><code>#include &lt;stdio.h&gt;
int main(){
    int count;
    printf(&quot;AB%n&quot;, &amp;count);
    printf(&quot;\n%d characters printed\n&quot;, count);
}
</code></pre><p>　　结果为：</p>
<pre><code>AB
2 characters printed
</code></pre><p>　　我们可以将任何内存地址放在<code>count</code>上来覆盖该地址的值。但是如果需要覆盖一个很大的地址值的话，我们需要打印大量的字符，这个是很傻的。幸运的是，另外一个格式化字符<code>%hn</code>作用于<code>short</code>而不是<code>int</code>，我们可以一次覆盖2个字节，从而组成一个我们想要的4字节的值。</p>
<p>　　接下来让我们试一下，使用两次<code>printf</code>调用，用我们想要的值（这里是函数<code>hello</code>的指针值）来覆盖<code>.fini_array</code>：</p>
<pre><code>#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;stdint.h&gt;

#define FUNCTION_ADDR ((uint64_t)hello)
#define DESTADDR 0x0000000000600948

void hello(){
    printf(&quot;\n\n\n\nhello world\n\n&quot;);
}

int main(int argc, char *argv[]){
    short a= FUNCTION_ADDR &amp; 0xffff;
    short b = (FUNCTION_ADDR &gt;&gt; 16) &amp; 0xffff;
    printf(&quot;a = %04x b = %04x\n&quot;, a, b);fflush(stdout);
    uint64_t *p = (uint64_t*)DESTADDR;
    printf(&quot;before: %08lx\n&quot;, *p); fflush(stdout);
    printf(&quot;%*c%hn&quot;, b, 0, DESTADDR + 2 );fflush(stdout);
    printf(&quot;after1: %08lx\n&quot;, *p); fflush(stdout);
    printf(&quot;%*c%hn&quot;, a, 0, DESTADDR);fflush(stdout);
    printf(&quot;after2: %08lx\n&quot;, *p); fflush(stdout);
    return 0;
}
</code></pre><p>　　其中关键的部分是：</p>
<pre><code>short a= FUNCTION_ADDR &amp; 0xffff;
short b = (FUNCTION_ADDR &gt;&gt; 16) &amp; 0xffff;
printf(&quot;%*c%hn&quot;, b, 0, DESTADDR + 2 );
printf(&quot;%*c%hn&quot;, a, 0, DESTADDR);
</code></pre><p>　　<code>a</code>和<code>b</code>其实就是函数地址值的一半（译者注：指针占4个字节，a、b是前后的两个字节），我们可以构建一个长度为<code>a</code>和<code>b</code>的字符串给<code>printf</code>函数输出，但这样就太繁琐了，所以我选择使用<code>%*</code>这个格式化字符，它可以通过参数来控制输出的长度。</p>
<p>　　例如，下面的代码：</p>
<pre><code>printf(&quot;%*c&quot;, 10, &#39;A&#39;);
</code></pre><p>　　它将会打印9个空格，紧随着输出字符<code>A</code>。所以，总共输出10个字符。</p>
<p>　　如果我们想只用一次<code>printf</code>，我们就需要记得，已经打印了<code>b</code>个字节，所以我们还需要打印另外的<code>b-a</code>（可能为负）个字节（输出的计数器是累加的）。</p>
<pre><code>printf(&quot;%*c%hn%*c%hn&quot;, b, 0, DESTADDR + 2, b-a, 0, DESTADDR );
</code></pre><p>　　例子中我们使用的是<code>hello</code>函数，但是实际上我们可以调用任何函数（或者说，任何地址）。我已经编写了一个只输出<code>Hello world</code>的web服务器的<code>shellcode</code>，如下：</p>
<pre><code>unsigned char hello[] = 
    &quot;\xeb\x3d\x48\x54\x54\x50\x2f\x31\x2e\x30\x20\x32&quot;
    &quot;\x30\x30\x0d\x0a\x43\x6f\x6e\x74\x65\x6e\x74\x2d&quot;
    &quot;\x74\x79\x70\x65\x3a\x74\x65\x78\x74\x2f\x68\x74&quot;
    &quot;\x6d\x6c\x0d\x0a\x0d\x0a\x3c\x68\x31\x3e\x48\x65&quot;
    &quot;\x6c\x6c\x6f\x20\x57\x6f\x72\x6c\x64\x21\x3c\x2f&quot;
    &quot;\x68\x31\x3e\x4c\x8d\x2d\xbc\xff\xff\xff\x48\x89&quot;
    &quot;\xe3\x48\x83\xeb\x10\x48\x31\xc0\x50\x66\xb8\x1f&quot;
    &quot;\x90\xc1\xe0\x10\xb0\x02\x50\x31\xd2\x31\xf6\xff&quot;
    &quot;\xc6\x89\xf7\xff\xc7\x31\xc0\xb0\x29\x0f\x05\x49&quot;
    &quot;\x89\xc2\x31\xd2\xb2\x10\x48\x89\xde\x89\xc7\x31&quot;
    &quot;\xc0\xb0\x31\x0f\x05\x31\xc0\xb0\x05\x89\xc6\x4c&quot;
    &quot;\x89\xd0\x89\xc7\x31\xc0\xb0\x32\x0f\x05\x31\xd2&quot;
    &quot;\x31\xf6\x4c\x89\xd0\x89\xc7\x31\xc0\xb0\x2b\x0f&quot;
    &quot;\x05\x49\x89\xc4\x48\x31\xd2\xb2\x3d\x4c\x89\xee&quot;
    &quot;\x4c\x89\xe7\x31\xc0\xff\xc0\x0f\x05\x31\xf6\xff&quot;
    &quot;\xc6\xff\xc6\x4c\x89\xe7\x31\xc0\xb0\x30\x0f\x05&quot;
    &quot;\x4c\x89\xe7\x31\xc0\xb0\x03\x0f\x05\xeb\xc3&quot;;
</code></pre><hr>
<p>注：<code>shellcode</code>是一种利用溢出漏洞来执行的特定代码。相关资料如下：</p>
<ul>
<li><a href="http://blog.csdn.net/maotoula/article/details/18502679" target="_blank" rel="noopener">Shellcode的原理及编写 </a></li>
<li><a href="http://blog.chinaunix.net/uid-24917554-id-3506660.html" target="_blank" rel="noopener">Shellcode的编写</a></li>
<li><a href="http://blog.chinaunix.net/uid-571104-id-2734570.html" target="_blank" rel="noopener">ShellCode的简单原理</a></li>
<li><a href="http://netsecurity.51cto.com/art/201211/367420.htm" target="_blank" rel="noopener">堆栈溢出技术从入门到高深：如何书写shell code</a></li>
<li><a href="http://zhaisj.blog.51cto.com/219066/61428/" target="_blank" rel="noopener">了解黑客的关键工具—揭开Shellcode的神秘面纱</a></li>
</ul>
<hr>
<p>　　如果我们将<code>hello</code>函数移除，插入上面的<code>shellcode</code>的话，这段<code>shellcode</code>就会被执行。</p>
<p>　　这个<code>shellcode</code>其实就是一个字符串（或者说，可以看做），所以我们可以将它插入到<code>%*c%hn%*c%hn</code>的后面。这个字符串是未命名的，所以我们需要在编译后找到它的地址。为了获取这个地址，我们需要编译这个代码，然后反编译为汇编：</p>
<p><code>objdump -d webserver</code></p>
<pre><code>......
......
00000000004004e6 &lt;main&gt;:
  4004e6:    55                       push   %rbp
  4004e7:    48 89 e5                 mov    %rsp,%rbp
  4004ea:    48 83 ec 10              sub    $0x10,%rsp
  4004ee:    89 7d fc                 mov    %edi,-0x4(%rbp)
  4004f1:    48 89 75 f0              mov    %rsi,-0x10(%rbp)
  4004f5:    48 83 ec 08              sub    $0x8,%rsp
  4004f9:    68 d8 07 60 00           pushq  $0x6007d8
  4004fe:    41 b9 00 00 00 00        mov    $0x0,%r9d
  400504:    41 b8 94 05 00 00        mov    $0x594,%r8d
  40050a:    b9 da 07 60 00           mov    $0x6007da,%ecx
  40050f:    ba 00 00 00 00           mov    $0x0,%edx
  400514:    be 40 00 00 00           mov    $0x40,%esi
  400519:    bf c8 05 40 00           mov    $0x4005c8,%edi
  40051e:    b8 00 00 00 00           mov    $0x0,%eax
  400523:    e8 98 fe ff ff           callq  4003c0 &lt;printf@plt&gt;
  400528:    48 83 c4 10              add    $0x10,%rsp
  40052c:    b8 00 00 00 00           mov    $0x0,%eax
  400531:    c9                       leaveq 
  400532:    c3                       retq   
  400533:    66 2e 0f 1f 84 00 00     nopw   %cs:0x0(%rax,%rax,1)
  40053a:    00 00 00 
  40053d:    0f 1f 00                 nopl   (%rax)
......
......
</code></pre><p>　　我们需要关心的是这一行：</p>
<pre><code>mov    $0x4005c8,%edi
</code></pre><p>　　这个<code>0x4005c8</code>就是我们在这里需要的地址：</p>
<pre><code>#define FUNCTION_ADDR ((uint64_t)0x4005c8 + 12)
</code></pre><p>　　这里的<code>+12</code>是必需的，因为我们的<code>shellcode</code>紧跟在字符串<code>%*c%hn%*c%hn</code>后，而它的长度是12个字符。</p>
<p>　　如果你对<code>shellcode</code>的来源感兴趣的话，它其实来自以下的C代码：</p>
<pre><code>#include&lt;stdio.h&gt;
#include&lt;string.h&gt;
#include&lt;stdlib.h&gt;
#include&lt;unistd.h&gt;
#include&lt;sys/types.h&gt;
#include&lt;sys/stat.h&gt;
#include&lt;sys/socket.h&gt;
#include&lt;arpa/inet.h&gt;
#include&lt;netdb.h&gt;
#include&lt;signal.h&gt;
#include&lt;fcntl.h&gt;

int main(int argc, char *argv[]){
    int sockfd = socket(AF_INET, SOCK_STREAM, 0);
    struct sockaddr_in serv_addr;
    bzero((char *)&amp;serv_addr, sizeof(serv_addr));
    serv_addr.sin_family = AF_INET;
    serv_addr.sin_addr.s_addr = INADDR_ANY;
    serv_addr.sin_port = htons(8080);
    bind(sockfd, (struct sockaddr *)&amp;serv_addr, sizeof(serv_addr));
    listen(sockfd, 5);
    while (1) {
        int cfd  = accept(sockfd, 0, 0);
        char *s = &quot;HTTP/1.0 200\r\nContent-type:text/html\r\n\r\n&lt;h1&gt;Hello world!&lt;/h1&gt;&quot;; 
        if (fork()==0) {
            write(cfd, s, strlen(s));
            shutdown(cfd, SHUT_RDWR);
            close(cfd);
        }    
    }

    return 0;
}
</code></pre><p>　　另外，我还做了一些额外的工作，从<code>shellcode</code>中移除了所有的<code>NUL</code>字符（尽管这个并不是必需的）。</p>
<blockquote>
<p><code>Jeff Dean</code>有一次用一句printf实现了一个web服务器。其他工程师添加了数千行注释但依然无法完全解释清楚其工作原理。而这个程序就是今天Google首页的前端。</p>
</blockquote>
<p>　　作为练习，读者可以自己修改一下这个web服务器，让它可以支持<code>Google搜索</code>前端的加载。</p>
<p>　　这篇博客的代码可以在这里找到：<a href="https://github.com/yohanes/printf-webserver" target="_blank" rel="noopener">https://github.com/yohanes/printf-webserver</a></p>
<p>　　对于那些认为这个毫无用处的人，我只想说：没错！它就是毫无用处！我只是恰好喜欢这个挑战，并且在解决这个问题的过程中，我刷新了对这些知识的认识：<code>shellcode</code>的编写（我已经几年没写过了）、<code>AMD64</code>平台的汇编、系统调用、<code>objdump</code>、<code>.fini_array</code>（上次我检查时，发现gcc还在用<code>.dtors</code>）、<code>printf</code>的格式化字符漏洞、<code>gdb</code>的使用技巧（例如将内存块导出为文件）以及低层次的<code>socket</code>编程（之前我一直使用<code>boost</code>）。</p>
<h1 id="写在后面"><a href="#写在后面" class="headerlink" title="写在后面"></a>写在后面</h1><p>　　最初看到这个笑话时，没有想到真的可以实现，原文作者真的是一个很geek的大神，在翻译的过程中，我学到了很多东西，例如动态链接、内存布局、函数调用栈、格式化字符串攻击等等。翻译的比较随便，很多术语没接触过，也翻译不出来，如果看得不是舒爽，可以直接看原文。</p>
<p>　　我的运行结果：</p>
<p><img src="run.png" alt=""></p>
<p><img src="result.png" alt=""></p>
<h1 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h1><p>　　很多人说没有看明白，我就根据自己的理解解释一下吧。</p>
<p>　　首先，这里涉及的技术有<code>动态链接库</code>的加载、初始化、卸载、终止等（上面有相关的资料），<code>格式化字符串攻击</code>，<code>shellcode</code>的原理及编写……</p>
<p>　　关键的一点是，覆盖<code>.fini_array</code>这个节，这个节的代码将会在动态链接库（或者可执行程序）卸载时被执行。这里再次给出相关的资料链接，<a href="http://docs.oracle.com/cd/E19253-01/819-7050/6n918j8mn/index.html#chapter2-48195" target="_blank" rel="noopener">初始化和终止节</a>。从中我们也可以知道，为什么是要覆盖终止节而不是初始化节，因为我们需要先使用printf()修改.fini_array节的内容，然后在程序结束时，这个节的内容就会被执行，覆盖初始化节的话，没有什么用，因为程序已经执行过修改前的初始化代码了。这个<code>初始化</code>和<code>终止节</code>，可以理解为C++中的<code>构造函数</code>和<code>析构函数</code>，只不过，涉及的不是类，而是链接库或者可执行程序。</p>
<p>　　其次，格式化字符串攻击。这个看一下上面的资料就能明白了，主要原理就是通过格式化字符串修改某个内存地址的值。这里就是通过这个来修改.fini_array。</p>
<p>　　最后，<code>shellcode</code>部分，这个就很geek了，具体原理以及shellcode的编写上面有相关的资料。原文作者已经编写了一个简单的web服务器的shellcode，.fini_array的值被修改为它的地址，所以它会在程序结束时被执行。理论上，只要你的shellcode有这么复杂，你几乎可以使用一句printf实现任何功能。</p>

        
    

    
</div>


                

                <!-- Post Comments -->
                
                    
    <!-- 使用 gitcoment -->
<div id="gitment-comment">
    <!-- Gitment 评论框 -->
<div id="container"></div>
</div>
<style>
    #gitment-comment{
        background-color: #eee;
        padding: 2pc;
    }
</style>
<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
<script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
<script>
    var gitment = new Gitment({
        id: 'https://w-angler.com/2016/12/05/用一个printf-语句实现一个web服务器/', // 可选。默认为 location.href
        owner: 'W-angler',
        repo: 'w-angler.github.io',
        oauth: {
            client_id: 'a3a3061c655fee6007da',
            client_secret: 'bc80f0e67bf63ff206c2efee14d8c76eb7a53472',
        },
    })
    gitment.render('container')
</script>


                
            </div>

            <!-- Post Prev & Next Nav -->
            <nav class="material-nav mdl-color-text--grey-50 mdl-cell mdl-cell--12-col">
    <!-- Prev Nav -->
    
        <a href="/2017/02/13/ubuntu下git服务器搭建/" id="post_nav-newer" class="prev-content">
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_back</i>
            </button>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            新篇
        </a>
    

    <!-- Section Spacer -->
    <div class="section-spacer"></div>

    <!-- Next Nav -->
    
        <a href="/2016/11/18/Y组合子及其实现/" id="post_nav-older" class="next-content">
            旧篇
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_forward</i>
            </button>
        </a>
    
</nav>

        </div>
    </div>



                    
                        <!-- Overlay For Active Sidebar -->
<div class="sidebar-overlay"></div>

<!-- Material sidebar -->
<aside id="sidebar" class="sidebar sidebar-colored sidebar-fixed-left" role="navigation">
    <div id="sidebar-main">
        <!-- Sidebar Header -->
        <div class="sidebar-header header-cover" style="background-image: url(/img/sidebar_header.png);">
    <!-- Top bar -->
    <div class="top-bar"></div>

    <!-- Sidebar toggle button -->
    <button type="button" class="sidebar-toggle mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" style="display: initial;" data-upgraded=",MaterialButton,MaterialRipple">
        <i class="material-icons">clear_all</i>
        <span class="mdl-button__ripple-container">
            <span class="mdl-ripple">
            </span>
        </span>
    </button>

    <!-- Sidebar Avatar -->
    <div class="sidebar-image">
        <img src="/img/avatar.jpg" alt="W-angler's avatar">
    </div>

    <!-- Sidebar Email -->
    <a data-toggle="dropdown" class="sidebar-brand" href="#settings-dropdown">
        wangler0408@gmail.com
        <b class="caret"></b>
    </a>
</div>


        <!-- Sidebar Navigation  -->
        <ul class="nav sidebar-nav">
    <!-- User dropdown  -->
    <li class="dropdown">
        <ul id="settings-dropdown" class="dropdown-menu">
            
                <li>
                    <a href="mailto:wangler0408@gmail.com" target="_blank" title="与我联系">
                        
                            <i class="material-icons sidebar-material-icons sidebar-indent-left1pc-element">email</i>
                        
                        与我联系
                    </a>
                </li>
            
                <li>
                    <a href="https://github.com/W-angler" target="_blank" title="github">
                        
                            <i class="material-icons sidebar-material-icons sidebar-indent-left1pc-element">code</i>
                        
                        github
                    </a>
                </li>
            
                <li>
                    <a href="/atom.xml" target="_blank" title="RSS">
                        
                            <i class="material-icons sidebar-material-icons sidebar-indent-left1pc-element">rss_feed</i>
                        
                        RSS
                    </a>
                </li>
            
        </ul>
    </li>

    <!-- Homepage -->
    
        <li id="sidebar-first-li">
            <a href="/">
                
                    <i class="material-icons sidebar-material-icons">home</i>
                
                主页
            </a>
        </li>
        
    

    <!-- Archives  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">inbox</i>
                
                    归档
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
            <li>
                <a class="sidebar_archives-link" href="/archives/2018/09/">九月 2018<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/12/">十二月 2017<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/09/">九月 2017<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/02/">二月 2017<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/12/">十二月 2016<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/11/">十一月 2016<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/10/">十月 2016<span class="sidebar_archives-count">8</span></a>
            </li></ul>
        </li>
        
    

    <!-- Categories  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">chrome_reader_mode</i>
                
                分类
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
                <li>
                <a class="sidebar_archives-link" href="/categories/Antlr/">Antlr<span class="sidebar_archives-count">5</span></a></li><li><a class="sidebar_archives-link" href="/categories/JVM/">JVM<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/categories/PLT/">PLT<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/categories/git/">git<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/categories/奇技淫巧/">奇技淫巧<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/categories/科研/">科研<span class="sidebar_archives-count">1</span></a>
            </li></ul>
        </li>
        
            <li class="divider"></li>
        
    

    <!-- Pages  -->
    
        <li>
            <a href="/atom.xml" title="RSS">
                
                    <i class="material-icons sidebar-material-icons">rss_feed</i>
                
                RSS
            </a>
        </li>
        
    
        <li>
            <a href="/tags" title="标签">
                
                    <i class="material-icons sidebar-material-icons">bookmark</i>
                
                标签
            </a>
        </li>
        
    
        <li>
            <a href="/timeline" title="时间轴">
                
                    <i class="material-icons sidebar-material-icons">timeline</i>
                
                时间轴
            </a>
        </li>
        
    
        <li>
            <a href="/gallery" title="相册">
                
                    <i class="material-icons sidebar-material-icons">collections</i>
                
                相册
            </a>
        </li>
        
    
        <li>
            <a href="/links" title="友情链接">
                
                    <i class="material-icons sidebar-material-icons">link</i>
                
                友情链接
            </a>
        </li>
        
    
        <li>
            <a href="/about" title="关于">
                
                    <i class="material-icons sidebar-material-icons">person</i>
                
                关于
            </a>
        </li>
        
            <li class="divider"></li>
        
    

    <!-- Article Number  -->
    
        <li>
            <a href="/archives">
                文章总数
                <span class="sidebar-badge">14</span>
            </a>
        </li>
        
    
</ul>


        <!-- Sidebar Footer -->
        <!--
I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright, I will thank you so much.
If you still want to delete the copyrights, could you still retain the first one? Which namely "Theme Material"
It will not impact the appearance and can give developers a lot of support :)

很高兴您使用并喜欢该主题，开发不易 十分谢谢与希望您可以保留一下版权声明。
如果您仍然想删除的话 能否只保留第一项呢？即 "Theme Material"
它不会影响美观并可以给开发者很大的支持和动力。 :)
-->

<!-- Sidebar Divider -->


<!-- Theme Material -->


<!-- Help & Support -->
<!--

-->

<!-- Feedback -->
<!--

-->

<!-- About Theme -->
<!--

-->

    </div>

    <!-- Sidebar Image -->
    

</aside>

                    

                    
                        <!-- Footer Top Button -->
                        <div id="back-to-top" class="toTop-wrap">
    <a href="#top" class="toTop">
        <i class="material-icons footer_top-i">expand_less</i>
    </a>
</div>

                    

                    <!--Footer-->
<footer class="mdl-mini-footer" id="bottom">
    
        <!-- Paradox Footer Left Section -->
        <div class="mdl-mini-footer--left-section sns-list">
    <!-- Twitter -->
    
        <a href="https://twitter.com/wangler0408" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-twitter">
                <span class="visuallyhidden">Twitter</span>
            </button><!--
     --></a>
    

    <!-- Facebook -->
    

    <!-- Google + -->
    
        <a href="https://plus.google.com/101029110222735975086" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-gplus">
                <span class="visuallyhidden">Google Plus</span>
            </button><!--
     --></a>
    

    <!-- Weibo -->
    

    <!-- Instagram -->
    

    <!-- Tumblr -->
    

    <!-- Github -->
    
        <a href="https://github.com/W-angler" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-github">
                <span class="visuallyhidden">Github</span>
            </button><!--
     --></a>
    

    <!-- LinkedIn -->
    
        <a href="https://cn.linkedin.com/in/%E9%B9%8F%E7%A8%8B-%E6%B1%AA-6332a5121" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-linkedin">
                <span class="visuallyhidden">LinkedIn</span>
            </button><!--
     --></a>
    

    <!-- Zhihu -->
    

    <!-- Bilibili -->
    

    <!-- Telegram -->
    

    <!-- V2EX -->
    

    <!-- Segmentfault -->
    
</div>


        <!--Copyright-->
        <div id="copyright">
            Copyright&nbsp;©&nbsp;<span year=""></span>&nbsp;年轻人啊不要熬夜
            
        </div>

        <!-- Paradox Footer Right Section -->

        <!--
        I am glad you use this theme, the development is no so easy, I hope you can keep the copyright.
        It will not impact the appearance and can give developers a lot of support :)

        很高兴您使用该主题，开发不易，希望您可以保留一下版权声明。
        它不会影响美观并可以给开发者很大的支持。 :)
        -->

        <div class="mdl-mini-footer--right-section">
            <div>
                <div class="footer-develop-div">Powered by <a href="https://hexo.io" target="_blank" class="footer-develop-a">Hexo</a></div>
                <div class="footer-develop-div">Theme - <a href="https://github.com/viosey/hexo-theme-material" target="_blank" class="footer-develop-a">Material</a></div>
            </div>
        </div>
    
</footer>


                    <!-- Import JS File -->

    <script>lsloader.load("lazyload_js","https://cdn.jsdelivr.net/gh/viosey/hexo-theme-material@1.5.6/source//js/lazyload.min.js", true)</script>



    <script>lsloader.load("js_js","https://cdn.jsdelivr.net/gh/viosey/hexo-theme-material@1.5.6/source//js/js.min.js", true)</script>



    <script>lsloader.load("np_js","https://cdn.bootcss.com/nprogress/0.2.0/nprogress.min.js", true)</script>


<script type="text/ls-javascript" id="NProgress-script">
    NProgress.configure({
        showSpinner: true
    });
    NProgress.start();
    $('#nprogress .bar').css({
        'background': '#29d'
    });
    $('#nprogress .peg').css({
        'box-shadow': '0 0 10px #29d, 0 0 15px #29d'
    });
    $('#nprogress .spinner-icon').css({
        'border-top-color': '#29d',
        'border-left-color': '#29d'
    });
    setTimeout(function() {
        NProgress.done();
        $('.fade').removeClass('out');
    }, 800);
</script>



    
        <script>lsloader.load("sm_js","https://cdn.jsdelivr.net/gh/viosey/hexo-theme-material@1.5.6/source//js/smoothscroll.js", true)</script>
    







   <!-- Gitment -->





<!-- UC Browser Compatible -->
<script>
	var agent = navigator.userAgent.toLowerCase();
	if(agent.indexOf('ucbrowser')>0) {
		document.write('<link rel="stylesheet" href="/css/uc.css">');
	   alert('由于 UC 浏览器使用极旧的内核，而本网站使用了一些新的特性。\n为了您能更好的浏览，推荐使用 Chrome 或 Firefox 浏览器。');
	}
</script>

<!-- Import prettify js  -->

    
        
            <script>lsloader.load("prettify_js","https://cdn.bootcss.com/prettify/r298/prettify.min.js", true)</script>
        
    



<!-- Window Load -->
<!-- add class for prettify -->
<script type="text/ls-javascript" id="window-load">
    $(window).on('load', function() {
        // Post_Toc parent position fixed
        $('.post-toc-wrap').parent('.mdl-menu__container').css('position', 'fixed');
    });

    
        
            $(function() {
                $('pre').addClass('prettyprint linenums').attr('style', 'overflow:auto;');
                prettyPrint();
                })
        
    
    
</script>

<!-- MathJax Load-->


<!-- Bing Background -->


<script type="text/ls-javascript" id="lazy-load">
    // Offer LazyLoad
    queue.offer(function(){
        $('.lazy').lazyload({
            effect : 'show'
        });
    });

    // Start Queue
    $(document).ready(function(){
        setInterval(function(){
            queue.execNext();
        },200);
    });
</script>

<!-- Custom Footer -->



<script>
    var copyrightNow = new Date().getFullYear();
    var textContent = document.querySelector('span[year]')

    copyrightSince = 2016;
    if (copyrightSince === copyrightNow||copyrightSince === 0000) {
        textContent.textContent = copyrightNow
    } else {
        textContent.textContent = copyrightSince + ' - ' + copyrightNow
    }

    (function(){
        var scriptList = document.querySelectorAll('script[type="text/ls-javascript"]')

        for (var i = 0; i < scriptList.length; ++i) {
            var item = scriptList[i];
            lsloader.runInlineScript(item.id,item.id);
        }
    })()
console.log('\n %c © Material Theme | Version: 1.5.6 | https://github.com/viosey/hexo-theme-material %c \n', 'color:#455a64;background:#e0e0e0;padding:5px 0;border-top-left-radius:5px;border-bottom-left-radius:5px;', 'color:#455a64;background:#e0e0e0;padding:5px 0;border-top-right-radius:5px;border-bottom-right-radius:5px;');
</script>

                </main>
            </div>
        </body>
    
</html>
