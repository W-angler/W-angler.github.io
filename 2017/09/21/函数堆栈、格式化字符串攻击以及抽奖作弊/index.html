<!DOCTYPE html>
<html style="display: none;" lang="zh">
    <head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
    <!--
        © Material Theme
        https://github.com/viosey/hexo-theme-material
        Version: 1.5.6 -->
    <script>
        window.materialVersion = "1.5.6"
        // Delete localstorage with these tags
        window.oldVersion = [
            'codestartv1',
            '1.3.4',
            '1.4.0',
            '1.4.0b1',
            '1.5.0',
            '1.5.2',
            '1.5.5'
        ]
    </script>

    <!-- dns prefetch -->
    <meta http-equiv="x-dns-prefetch-control" content="on">

    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net/gh/viosey/hexo-theme-material@1.5.6/source/">





    <link rel="dns-prefetch" href="https://imsun.github.io">



    <link rel="dns-prefetch" href="https://www.google-analytics.com">



    <link rel="dns-prefetch" href="https://lib.baomitu.com">





    <!-- Meta & Info -->
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta name="renderer" content="webkit">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!-- Title -->
    
    <title>
        
            函数堆栈、格式化字符串攻击以及抽奖作弊 | 
        
        年轻人啊不要熬夜
    </title>

    <!-- Favicons -->
    <link rel="icon shortcut" type="image/ico" href="/img/favicon.jpg">
    <link rel="icon" href="/img/favicon.jpg">

    <meta name="format-detection" content="telephone=no">
    <meta name="description" itemprop="description" content="">
    <meta name="keywords" content=",C,格式化字符串攻击,反汇编,函数堆栈">
    <meta name="theme-color" content="#0097A7">

    <!-- Disable Fucking Bloody Baidu Tranformation -->
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta http-equiv="Cache-Control" content="no-siteapp">

    <!--[if lte IE 9]>
        <link rel="stylesheet" href="/css/ie-blocker.css">

        
            <script src="/js/ie-blocker.zhCN.js"></script>
        
    <![endif]-->

    <!-- Import lsloader -->
    <script>(function(){window.lsloader={jsRunSequence:[],jsnamemap:{},cssnamemap:{}};lsloader.removeLS=function(a){try{localStorage.removeItem(a)}catch(b){}};lsloader.setLS=function(a,c){try{localStorage.setItem(a,c)}catch(b){}};lsloader.getLS=function(a){var c="";try{c=localStorage.getItem(a)}catch(b){c=""}return c};versionString="/*"+(window.materialVersion||"unknownVersion")+"*/";lsloader.clean=function(){try{var b=[];for(var a=0;a<localStorage.length;a++){b.push(localStorage.key(a))}b.forEach(function(e){var f=lsloader.getLS(e);if(window.oldVersion){var d=window.oldVersion.reduce(function(g,h){return g||f.indexOf("/*"+h+"*/")!==-1},false);if(d){lsloader.removeLS(e)}}})}catch(c){}};lsloader.clean();lsloader.load=function(f,a,b,d){if(typeof b==="boolean"){d=b;b=undefined}d=d||false;b=b||function(){};var e;e=this.getLS(f);if(e&&e.indexOf(versionString)===-1){this.removeLS(f);this.requestResource(f,a,b,d);return}if(e){var c=e.split(versionString)[0];if(c!=a){console.log("reload:"+a);this.removeLS(f);this.requestResource(f,a,b,d);return}e=e.split(versionString)[1];if(d){this.jsRunSequence.push({name:f,code:e});this.runjs(a,f,e)}else{document.getElementById(f).appendChild(document.createTextNode(e));b()}}else{this.requestResource(f,a,b,d)}};lsloader.requestResource=function(b,e,a,c){var d=this;if(c){this.iojs(e,b,function(h,f,g){d.setLS(f,h+versionString+g);d.runjs(h,f,g)})}else{this.iocss(e,b,function(f){document.getElementById(b).appendChild(document.createTextNode(f));d.setLS(b,e+versionString+f)},a)}};lsloader.iojs=function(d,b,g){var a=this;a.jsRunSequence.push({name:b,code:""});try{var f=new XMLHttpRequest();f.open("get",d,true);f.onreadystatechange=function(){if(f.readyState==4){if((f.status>=200&&f.status<300)||f.status==304){if(f.response!=""){g(d,b,f.response);return}}a.jsfallback(d,b)}};f.send(null)}catch(c){a.jsfallback(d,b)}};lsloader.iocss=function(f,c,h,a){var b=this;try{var g=new XMLHttpRequest();g.open("get",f,true);g.onreadystatechange=function(){if(g.readyState==4){if((g.status>=200&&g.status<300)||g.status==304){if(g.response!=""){h(g.response);a();return}}b.cssfallback(f,c,a)}};g.send(null)}catch(d){b.cssfallback(f,c,a)}};lsloader.iofonts=function(f,c,h,a){var b=this;try{var g=new XMLHttpRequest();g.open("get",f,true);g.onreadystatechange=function(){if(g.readyState==4){if((g.status>=200&&g.status<300)||g.status==304){if(g.response!=""){h(g.response);a();return}}b.cssfallback(f,c,a)}};g.send(null)}catch(d){b.cssfallback(f,c,a)}};lsloader.runjs=function(f,c,e){if(!!c&&!!e){for(var b in this.jsRunSequence){if(this.jsRunSequence[b].name==c){this.jsRunSequence[b].code=e}}}if(!!this.jsRunSequence[0]&&!!this.jsRunSequence[0].code&&this.jsRunSequence[0].status!="failed"){var a=document.createElement("script");a.appendChild(document.createTextNode(this.jsRunSequence[0].code));a.type="text/javascript";document.getElementsByTagName("head")[0].appendChild(a);this.jsRunSequence.shift();if(this.jsRunSequence.length>0){this.runjs()}}else{if(!!this.jsRunSequence[0]&&this.jsRunSequence[0].status=="failed"){var d=this;var a=document.createElement("script");a.src=this.jsRunSequence[0].path;a.type="text/javascript";this.jsRunSequence[0].status="loading";a.onload=function(){d.jsRunSequence.shift();if(d.jsRunSequence.length>0){d.runjs()}};document.body.appendChild(a)}}};lsloader.tagLoad=function(b,a){this.jsRunSequence.push({name:a,code:"",path:b,status:"failed"});this.runjs()};lsloader.jsfallback=function(c,b){if(!!this.jsnamemap[b]){return}else{this.jsnamemap[b]=b}for(var a in this.jsRunSequence){if(this.jsRunSequence[a].name==b){this.jsRunSequence[a].code="";this.jsRunSequence[a].status="failed";this.jsRunSequence[a].path=c}}this.runjs()};lsloader.cssfallback=function(e,c,b){if(!!this.cssnamemap[c]){return}else{this.cssnamemap[c]=1}var d=document.createElement("link");d.type="text/css";d.href=e;d.rel="stylesheet";d.onload=d.onerror=b;var a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(d,a)};lsloader.runInlineScript=function(c,b){var a=document.getElementById(b).innerText;this.jsRunSequence.push({name:c,code:a});this.runjs()}})();</script>

    <!-- Import queue -->
    <script>function Queue(){this.dataStore=[];this.offer=b;this.poll=d;this.execNext=a;this.debug=false;this.startDebug=c;function b(e){if(this.debug){console.log("Offered a Queued Function.")}if(typeof e==="function"){this.dataStore.push(e)}else{console.log("You must offer a function.")}}function d(){if(this.debug){console.log("Polled a Queued Function.")}return this.dataStore.shift()}function a(){var e=this.poll();if(e!==undefined){if(this.debug){console.log("Run a Queued Function.")}e()}}function c(){this.debug=true}}var queue=new Queue();</script>

    <!-- Import CSS -->
    
        <style id="material_css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("material_css","https://cdn.jsdelivr.net/gh/viosey/hexo-theme-material@1.5.6/source//css/material.min.css",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>
        <style id="style_css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("style_css","https://cdn.jsdelivr.net/gh/viosey/hexo-theme-material@1.5.6/source//css/style.min.css",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>

        
            
                <style id="prettify_css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("prettify_css","https://cdn.jsdelivr.net/gh/viosey/hexo-theme-material@1.5.6/source//css/prettify.min.css",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>
                <style id="prettify_theme"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("prettify_theme","https://cdn.jsdelivr.net/gh/viosey/hexo-theme-material@1.5.6/source//css/prettify/tomorrow-night-eighties.min.css",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>
            
        

    

    

    <!-- Config CSS -->

<!-- Other Styles -->
<style>
  body, html {
    font-family: Roboto, "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "微软雅黑", Arial, sans-serif;
    overflow-x: hidden !important;
  }
  
  code {
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
  }

  a {
    color: #00838F;
  }

  .mdl-card__media,
  #search-label,
  #search-form-label:after,
  #scheme-Paradox .hot_tags-count,
  #scheme-Paradox .sidebar_archives-count,
  #scheme-Paradox .sidebar-colored .sidebar-header,
  #scheme-Paradox .sidebar-colored .sidebar-badge{
    background-color: #0097A7 !important;
  }

  /* Sidebar User Drop Down Menu Text Color */
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:hover,
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:focus {
    color: #0097A7 !important;
  }

  #post_entry-right-info,
  .sidebar-colored .sidebar-nav li:hover > a,
  .sidebar-colored .sidebar-nav li:hover > a i,
  .sidebar-colored .sidebar-nav li > a:hover,
  .sidebar-colored .sidebar-nav li > a:hover i,
  .sidebar-colored .sidebar-nav li > a:focus i,
  .sidebar-colored .sidebar-nav > .open > a,
  .sidebar-colored .sidebar-nav > .open > a:hover,
  .sidebar-colored .sidebar-nav > .open > a:focus,
  #ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a {
    color: #0097A7 !important;
  }

  .toTop {
    background: #757575 !important;
  }

  .material-layout .material-post>.material-nav,
  .material-layout .material-index>.material-nav,
  .material-nav a {
    color: #757575;
  }

  #scheme-Paradox .MD-burger-layer {
    background-color: #757575;
  }

  #scheme-Paradox #post-toc-trigger-btn {
    color: #757575;
  }

  .post-toc a:hover {
    color: #00838F;
    text-decoration: underline;
  }

</style>


<!-- Theme Background Related-->

    <style>
      body{
        background-color: #F5F5F5;
      }

      /* blog_info bottom background */
      #scheme-Paradox .material-layout .something-else .mdl-card__supporting-text{
        background-color: #fff;
      }
    </style>




<!-- Fade Effect -->

    <style>
      .fade {
        transition: all 800ms linear;
        -webkit-transform: translate3d(0,0,0);
        -moz-transform: translate3d(0,0,0);
        -ms-transform: translate3d(0,0,0);
        -o-transform: translate3d(0,0,0);
        transform: translate3d(0,0,0);
        opacity: 1;
      }

      .fade.out{
        opacity: 0;
      }
    </style>


<!-- Import Font -->
<!-- Import Roboto -->

    <style>
        @font-face {
            font-family: Roboto;
            font-style: normal;
            font-weight: 300;
            src: url(https://lib.baomitu.com/fonts/roboto/roboto-v15-latin-300.eot);
            src: local('Roboto'),local('Roboto-Normal'),url(https://lib.baomitu.com/fonts/roboto/roboto-v15-latin-300.eot?#iefix) format('embedded-opentype'),url(https://lib.baomitu.com/fonts/roboto/roboto-v15-latin-300.woff2) format('woff2'),url(https://lib.baomitu.com/fonts/roboto/roboto-v15-latin-300.woff) format('woff'),url(https://lib.baomitu.com/fonts/roboto/roboto-v15-latin-300.ttf) format('truetype'),url(https://lib.baomitu.com/fonts/roboto/roboto-v15-latin-300.svg#Roboto) format('svg')
        }

        @font-face {
            font-family: Roboto;
            font-style: normal;
            font-weight: regular;
            src: url(https://lib.baomitu.com/fonts/roboto/roboto-v15-latin-regular.eot);
            src: local('Roboto'),local('Roboto-Normal'),url(https://lib.baomitu.com/fonts/roboto/roboto-v15-latin-regular.eot?#iefix) format('embedded-opentype'),url(https://lib.baomitu.com/fonts/roboto/roboto-v15-latin-regular.woff2) format('woff2'),url(https://lib.baomitu.com/fonts/roboto/roboto-v15-latin-regular.woff) format('woff'),url(https://lib.baomitu.com/fonts/roboto/roboto-v15-latin-regular.ttf) format('truetype'),url(https://lib.baomitu.com/fonts/roboto/roboto-v15-latin-regular.svg#Roboto) format('svg')
        }

        @font-face {
            font-family: Roboto;
            font-style: normal;
            font-weight: 500;
            src: url(https://lib.baomitu.com/fonts/roboto/roboto-v15-latin-500.eot);
            src: local('Roboto'),local('Roboto-Normal'),url(https://lib.baomitu.com/fonts/roboto/roboto-v15-latin-500.eot?#iefix) format('embedded-opentype'),url(https://lib.baomitu.com/fonts/roboto/roboto-v15-latin-500.woff2) format('woff2'),url(https://lib.baomitu.com/fonts/roboto/roboto-v15-latin-500.woff) format('woff'),url(https://lib.baomitu.com/fonts/roboto/roboto-v15-latin-500.ttf) format('truetype'),url(https://lib.baomitu.com/fonts/roboto/roboto-v15-latin-500.svg#Roboto) format('svg')
        }
    </style>


<!-- Import Material Icons -->


    <style id="material_icons"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("material_icons","https://cdn.jsdelivr.net/gh/viosey/hexo-theme-material@1.5.6/source//css/material-icons.css",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>




    <!-- Import jQuery -->
    
        <script>lsloader.load("jq_js","https://cdn.bootcss.com/jquery/2.2.0/jquery.min.js", true)</script>
    

    <!-- WebAPP Icons -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="年轻人啊不要熬夜">
    <meta name="msapplication-starturl" content="https://w-angler.com/2017/09/21/函数堆栈、格式化字符串攻击以及抽奖作弊/">
    <meta name="msapplication-navbutton-color" content="#0097A7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="年轻人啊不要熬夜">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon" href="/img/favicon.jpg">

    <!-- Site Verification -->
    
    

    <!-- RSS -->
    
        
            <link rel="alternate" type="application/atom+xml" href="/atom.xml">
        
    

    <!-- The Open Graph protocol -->
    <meta property="og:url" content="https://w-angler.com/2017/09/21/函数堆栈、格式化字符串攻击以及抽奖作弊/">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="函数堆栈、格式化字符串攻击以及抽奖作弊 | 年轻人啊不要熬夜">
    <meta property="og:image" content="/img/favicon.jpg">
    <meta property="og:description" content="">
    <meta property="og:article:tag" content="C"> <meta property="og:article:tag" content="格式化字符串攻击"> <meta property="og:article:tag" content="反汇编"> <meta property="og:article:tag" content="函数堆栈"> 

    
        <meta property="article:published_time" content="Thu Sep 21 2017 01:04:32 GMT+0800">
        <meta property="article:modified_time" content="Sun Apr 01 2018 19:14:15 GMT+0800">
    

    <!-- The Twitter Card protocol -->
    <meta name="twitter:card" content="summary_large_image">

    <!-- Add canonical link for SEO -->
    
        <link rel="canonical" href="https://w-angler.com/2017/09/21/函数堆栈、格式化字符串攻击以及抽奖作弊/index.html">
    

    <!-- Structured-data for SEO -->
    
        


<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage": "https://w-angler.com/2017/09/21/函数堆栈、格式化字符串攻击以及抽奖作弊/index.html",
    "headline": "函数堆栈、格式化字符串攻击以及抽奖作弊",
    "datePublished": "Thu Sep 21 2017 01:04:32 GMT+0800",
    "dateModified": "Sun Apr 01 2018 19:14:15 GMT+0800",
    "author": {
        "@type": "Person",
        "name": "W-angler",
        "image": {
            "@type": "ImageObject",
            "url": "/img/avatar.jpg"
        },
        "description": "A monad is just a monoid in the category of endofunctors, what's the problem?"
    },
    "publisher": {
        "@type": "Organization",
        "name": "年轻人啊不要熬夜",
        "logo": {
            "@type":"ImageObject",
            "url": "/img/favicon.jpg"
        }
    },
    "keywords": ",C,格式化字符串攻击,反汇编,函数堆栈",
    "description": "",
}
</script>


    

    <!-- Analytics -->
    
        <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-89109775-1', 'auto');ga('send', 'pageview');
</script>
    
    
    

    <!-- Custom Head -->
    

</head>


    
        <body id="scheme-Paradox" class="lazy">
            <div class="material-layout  mdl-js-layout has-drawer is-upgraded">
                

                <!-- Main Container -->
                <main class="material-layout__content" id="main">

                    <!-- Top Anchor -->
                    <div id="top"></div>

                    
                        <!-- Hamburger Button -->
                        <button class="MD-burger-icon sidebar-toggle">
                            <span id="MD-burger-id" class="MD-burger-layer"></span>
                        </button>
                    

                    <!-- Post TOC -->

    
    <!-- Back Button -->
    <!--
    <div class="material-back" id="backhome-div" tabindex="0">
        <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon"
           href="#" onclick="window.history.back();return false;"
           target="_self"
           role="button"
           data-upgraded=",MaterialButton,MaterialRipple">
            <i class="material-icons" role="presentation">arrow_back</i>
            <span class="mdl-button__ripple-container">
                <span class="mdl-ripple"></span>
            </span>
        </a>
    </div>
    -->


    <!-- Left aligned menu below button -->
    
    
    <button id="post-toc-trigger-btn" class="mdl-button mdl-js-button mdl-button--icon">
        <i class="material-icons">format_list_numbered</i>
    </button>

    <ul class="post-toc-wrap mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect" for="post-toc-trigger-btn" style="max-height:80vh; overflow-y:scroll;">
        <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#缘由"><span class="post-toc-number">1.</span> <span class="post-toc-text">缘由</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#代码"><span class="post-toc-number">2.</span> <span class="post-toc-text">代码</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#编译、运行"><span class="post-toc-number">3.</span> <span class="post-toc-text">编译、运行</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#原理"><span class="post-toc-number">4.</span> <span class="post-toc-text">原理</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#x86、x64的堆栈结构"><span class="post-toc-number">4.1.</span> <span class="post-toc-text">x86、x64的堆栈结构</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#终止节与格式化字符串攻击"><span class="post-toc-number">4.2.</span> <span class="post-toc-text">终止节与格式化字符串攻击</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#整体的流程"><span class="post-toc-number">4.3.</span> <span class="post-toc-text">整体的流程</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#黑魔法的破灭"><span class="post-toc-number">4.4.</span> <span class="post-toc-text">黑魔法的破灭</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#写在最后"><span class="post-toc-number">4.4.0.1.</span> <span class="post-toc-text">写在最后</span></a></li></ol></li></ol></li></ol>
    </ul>
    




<!-- Layouts -->

    <!-- Post Module -->
    <div class="material-post_container">

        <div class="material-post mdl-grid">
            <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">

                <!-- Post Header(Thumbnail & Title) -->
                
    <!-- Paradox Post Header -->
    
        
            <!-- Random Thumbnail -->
            <div class="post_thumbnail-random mdl-card__media mdl-color-text--grey-50">
            <script type="text/ls-javascript" id="post-thumbnail-script">
    var randomNum = Math.floor(Math.random() * 19 + 1);

    $('.post_thumbnail-random').attr('data-original', '/img/random/material-' + randomNum + '.png');
    $('.post_thumbnail-random').addClass('lazy');
</script>

        
    
            <p class="article-headline-p">
                函数堆栈、格式化字符串攻击以及抽奖作弊
            </p>
        </div>





                
                    <!-- Paradox Post Info -->
                    <div class="mdl-color-text--grey-700 mdl-card__supporting-text meta">

    <!-- Author Avatar -->
    <div id="author-avatar">
        <img src="/img/avatar.jpg" width="44px" height="44px" alt="Author Avatar">
    </div>
    <!-- Author Name & Date -->
    <div>
        <strong>W-angler</strong>
        <span>9月 21, 2017</span>
    </div>

    <div class="section-spacer"></div>

    <!-- Favorite -->
    <!--
        <button id="article-functions-like-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon btn-like">
            <i class="material-icons" role="presentation">favorite</i>
            <span class="visuallyhidden">favorites</span>
        </button>
    -->

    <!-- Qrcode -->
    
        <button id="article-functions-qrcode-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
    <i class="material-icons" role="presentation">devices other</i>
    <span class="visuallyhidden">devices other</span>
</button>
<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-functions-qrcode-button">
    <li class="mdl-menu__item">在其它设备中阅读本文章</li>
    
        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQ4AAAEOCAAAAABd2qZ5AAADe0lEQVR42u3aQW4jMQwEQP//07vXBRaZdJOS4wA1p8CxZ6TyoU2Krz+uf64XAhw4cODAgQMHDhw4PpjjFV9ffap48Bf3fH49We1qLzhw4MCB4wJHso2W43m5+fYS0NVecODAgQPHNY5kWe1mnhf9zLoJ5oIYBw4cOHB8DMc+ek8R48CBAweO386Rt+3a8q+9w0cELQ4cOHDgWDTUNqHYArXl3w/0SnHgwIEDx3qg4fP/fut8Bw4cOHDg+I+jvfIGXzs2NxtTSJ71zUpw4MCBA8dRjjyoZluahXd7t9n6ceDAgQPHPY76FuVgQd5qzBuUyTqT9+PAgQMHjrMcs8cfC7lFhLdMOHDgwIHjPRz7Jt0sbus4XADVzUEcOHDgwHGUIy+TZm3EZ8p8w89jc0mpiQMHDhw4bnDMoi5v/OXxnN95U4LiwIEDB47bHLPG32bz7YFWe89kFzhw4MCB4zZH28JrIy0flUu+pGQkIg9mHDhw4MBxliMfX8ijcfPOV3ntyz8cOHDgwHGWY1Z65eXcbGxuFqUtHA4cOHDguMGRb6895mmD/MZTkrjFgQMHDhw3OJKBhnaYoCVoByDaSMaBAwcOHO/hSAja0iu522ZsIkHPfy7gwIEDB47bHPnmZyXWDD2nrIctcODAgQPHUY58pKCNtzw4N2MKSZx/s18cOHDgwHGUo912/tk8mHOstgV5rDmIAwcOHDhKjuSVs6Nypwbd2r3gwIEDB47bHC3KbCmbIm124LRqDuLAgQMHjvWx0yZ6ZwNqbdyeHafAgQMHDhw/xRGNmo2Ol/IW4aYVeLiixYEDBw4co4GGsyXTpiS7N2yBAwcOHDjuceQbaA+cnj91b/QhP8TCgQMHDhzv4cjbc/nRVFuA5bgHikMcOHDgwHGNY9bIyxuFCWvb8muH6nDgwIEDx/s5klvkZVWLmKwk/3FwIGhx4MCBA8ehY6fZcVQLvQ/4lhgHDhw4cNzmaIMqD9RZGbYvFOuvDQcOHDhwXOBow7U9TNocWe3Ly4sVLQ4cOHDgKAca8vfk/501+9rxiySAceDAgQPH53DksdoG6mzoYVPI4cCBAweOT+DIm4CzeE7IZkBFcxAHDhw4cKw5Ng24vFSrR9kWTcPopwAOHDhw4LjAcXa5sybdc4jOnj4MWhw4cODAseBw4cCBAwcOHDhw4MCB48Ouvzt9Z3CwLH69AAAAAElFTkSuQmCC">
    
</ul>

    

    <!-- Tags (bookmark) -->
    
    <button id="article-functions-viewtags-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
        <i class="material-icons" role="presentation">bookmark</i>
        <span class="visuallyhidden">bookmark</span>
    </button>
    <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-functions-viewtags-button">
        <li class="mdl-menu__item">
        <a class="post_tag-link" href="/tags/C/">C</a></li><li class="mdl-menu__item"><a class="post_tag-link" href="/tags/函数堆栈/">函数堆栈</a></li><li class="mdl-menu__item"><a class="post_tag-link" href="/tags/反汇编/">反汇编</a></li><li class="mdl-menu__item"><a class="post_tag-link" href="/tags/格式化字符串攻击/">格式化字符串攻击</a>
    </li></ul>
    

    <!-- Share -->
    
        <button id="article-fuctions-share-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
    <i class="material-icons" role="presentation">share</i>
    <span class="visuallyhidden">share</span>
</button>
<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-fuctions-share-button">
    

    

    <!-- Share Weibo -->
    
        <a class="post_share-link" href="http://service.weibo.com/share/share.php?appkey=&title=函数堆栈、格式化字符串攻击以及抽奖作弊&url=https://w-angler.com/2017/09/21/函数堆栈、格式化字符串攻击以及抽奖作弊/index.html&pic=https://w-angler.com/img/favicon.jpg&searchPic=false&style=simple" target="_blank">
            <li class="mdl-menu__item">
                分享到微博
            </li>
        </a>
    

    <!-- Share Twitter -->
    
        <a class="post_share-link" href="https://twitter.com/intent/tweet?text=函数堆栈、格式化字符串攻击以及抽奖作弊&url=https://w-angler.com/2017/09/21/函数堆栈、格式化字符串攻击以及抽奖作弊/index.html&via=W-angler" target="_blank">
            <li class="mdl-menu__item">
                分享到 Twitter
            </li>
        </a>
    

    <!-- Share Facebook -->
    
        <a class="post_share-link" href="https://www.facebook.com/sharer/sharer.php?u=https://w-angler.com/2017/09/21/函数堆栈、格式化字符串攻击以及抽奖作弊/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Facebook
            </li>
        </a>
    

    <!-- Share Google+ -->
    
        <a class="post_share-link" href="https://plus.google.com/share?url=https://w-angler.com/2017/09/21/函数堆栈、格式化字符串攻击以及抽奖作弊/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Google+
            </li>
        </a>
    

    <!-- Share LinkedIn -->
    
        <a class="post_share-link" href="https://www.linkedin.com/shareArticle?mini=true&url=https://w-angler.com/2017/09/21/函数堆栈、格式化字符串攻击以及抽奖作弊/index.html&title=函数堆栈、格式化字符串攻击以及抽奖作弊" target="_blank">
            <li class="mdl-menu__item">
                分享到 LinkedIn
            </li>
        </a>
    

    <!-- Share QQ -->
    
        <a class="post_share-link" href="http://connect.qq.com/widget/shareqq/index.html?site=年轻人啊不要熬夜&title=函数堆栈、格式化字符串攻击以及抽奖作弊&summary=&pics=https://w-angler.com/img/favicon.jpg&url=https://w-angler.com/2017/09/21/函数堆栈、格式化字符串攻击以及抽奖作弊/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 QQ
            </li>
        </a>
    

    <!-- Share Telegram -->
    
        <a class="post_share-link" href="https://telegram.me/share/url?url=https://w-angler.com/2017/09/21/函数堆栈、格式化字符串攻击以及抽奖作弊/index.html&text=函数堆栈、格式化字符串攻击以及抽奖作弊" target="_blank">
            <li class="mdl-menu__item">
                分享到 Telegram
            </li>
        </a>
    
</ul>

    
</div>

                

                <!-- Post Content -->
                <div id="post-content" class="mdl-color-text--grey-700 mdl-card__supporting-text fade out">
    
        <p>　　因为之前一直很忙，没有精力写博客，这是时隔半年多来的第一篇博客。</p>
<p>　　这篇博客的代码内容是蹭研究生的《密码学》课程时，第一节上课前老师布置的一个小任务：写一个抽奖程序并且在代码中作弊，还要尽量让别人看不出来作弊。</p>
<p>　　虽然我的这个实现非常暴力并且不满足信息隐藏的基本条件，但是在展示完后，大家都没看出来原理，顺利拿到了5分满分。因为有几个人问了我关于实现的原理，所以在此说明一下。</p>
<p>　　本博客相关的代码：<a href="https://github.com/W-angler/CheatInADraw" target="_blank" rel="noopener">W-angler/CheatInADraw</a></p>
<h1 id="缘由"><a href="#缘由" class="headerlink" title="缘由"></a>缘由</h1><p>　　保研之后，为了防止自己堕落，选了几个研究生的课无耻地去蹭了，其中包括了课题组的老师的《密码学》研究生课程。结果第一节课之前，老师就布置了一个小任务，要求如下：</p>
<ul>
<li>假设现场有N个人参与抽奖，你写个程序，抽出M个人获奖</li>
<li>抽奖的结果要随机</li>
<li>每个人不能重复获奖</li>
<li>在完成上述的要求后，设法在程序中作弊，使得某些人获奖的概率更高</li>
<li>在以上完成的基础上，尽可能隐蔽你的作弊，从源代码上看不出来你作弊了</li>
<li>实现的语言不限，思路不限</li>
<li>每个人带着自己的程序以及源码，上台展示，先review代码，如果被发现作弊原理，那么扣相应的分数；否则展示程序结果，展示随机性和作弊结果，满分5分</li>
</ul>
<p>　　当看到这个时，其实第一个想法是在伪随机数生成上做文章，但是后来还是放弃了，感觉太容易看出来了。后来经过思考，决定使用一些很危险的技巧来完成这个程序。</p>
<h1 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h1><p>　　为了方便，这里还是贴出代码：</p>
<p><code>draw.c</code></p>
<pre><code class="c">#include&lt;stdio.h&gt;
#include&lt;stdlib.h&gt;
#include&lt;string.h&gt;
#include&lt;stdint.h&gt;
#include&lt;unistd.h&gt;
#include&lt;fcntl.h&gt;

#define FINALIZER    (0x0000000000600d38)
#define MAGIC_NUMBER (0x600fb0)
#define ADDR         (0x0000000000400733)
#define OFFSET       (46)

char* random_dev = &quot;/dev/urandom&quot;;//Truly Random Number Generator provided by linux kernal
char* people;                     //win 1, not win 0
int total;
int lucky_dogs;
int last_dog;
int random_fd;

//Read random number between 0 and total
int read_random(int fd, int total, char* people);
//A black magic
void black_magic(int* incantation){ *(((long *)&amp;incantation) + 2) += *incantation; }
//print the last one winner
void last(){
  printf(&quot;The last lucky dog is %d\n&quot;, people[last_dog] ? read_random(random_fd, total, people) : last_dog);
}

int main(int argc, char** argv){
  if(argc != 3){
    printf(&quot;%s [total] [lucky dog]\n&quot;, argv[0]);
  }
  else{
    total = atoi(argv[1]);
    lucky_dogs = atoi(argv[2]);
    if(lucky_dogs &gt;= total){
      printf(&quot;Oops...Not all of you can be lucky dog!\n&quot;);
      return -1;
    }
    people = (char*)calloc(total, sizeof(char));//Avoiding winning twice
    random_fd= open(random_dev, O_RDONLY);//Open Random Number Generator
    if(random_fd == -1){
      printf(&quot;unable to open %s&quot;, random_dev);
      return -1;
    }
    //choose (lucky_dogs - 1) people firstly
    int i, stop;
    for(i = 0, stop = lucky_dogs - 1; i &lt; stop; i++){
      printf(&quot;No.%d lucky dog is %d\n&quot;, i, read_random(random_fd, total, people));
    }
    //choose the last one
    if(i == lucky_dogs - 1){//must be true
      int incantation;
      printf(&quot;%*c%n&quot;, OFFSET, 0, &amp;incantation);
      black_magic(&amp;incantation);
      last_dog = read_random(random_fd, total, people);
      last();
    }
    else{
      printf(&quot;%*c%n&quot;, (*((int*)MAGIC_NUMBER)&gt;&gt;1), 0, ((int*)MAGIC_NUMBER) + 2);
      printf(&quot;%*c%hn&quot;, (ADDR &gt;&gt; 16) &amp; 0xffff, 0, (short*)(FINALIZER + 2));
      printf(&quot;%*c%hn&quot;, ADDR &amp; 0xffff, 0, (short*)(FINALIZER));
      printf(&quot;\n&quot;);
    }
  }
  return 0;
}

int read_random(int random_fd, int total, char* people){
  int dog;
  char random_bytes[sizeof(int)];
  do{
    read(random_fd, random_bytes, sizeof(int));
    dog = abs(*((int*)random_bytes) % total);
  }while(people[dog]);
  people[dog] = 1;
  return dog;
}
</code></pre>
<p>　　这段代码经过测试可以在64位的Ubuntu系统上运行（可能还和gcc的版本有关）。</p>
<h1 id="编译、运行"><a href="#编译、运行" class="headerlink" title="编译、运行"></a>编译、运行</h1><p>　　1、编译这段代码：</p>
<pre><code class="sh">gcc -Wl,-z,norelro draw.c -o draw
</code></pre>
<p>　　2、查看<code>.fini_array</code>的地址：</p>
<pre><code class="sh">objdump -h -j .fini_array draw
</code></pre>
<p>　　然后找到<code>VMA</code>（Virtual Memory Area，虚拟内存空间）的地址：</p>
<pre><code class="sh">draw：     文件格式 elf64-x86-64

节：
Idx Name          Size      VMA               LMA               File off  Algn
 19 .fini_array   00000008  0000000000600d38  0000000000600d38  00000d38  2**3
                  CONTENTS, ALLOC, LOAD, DATA
</code></pre>
<p>　　3、将<code>FINALIZER</code>改为<code>VMA</code>的值；</p>
<p>　　4、反汇编<code>draw</code>：</p>
<pre><code class="sh">objdump -d ./draw &gt; draw.s
</code></pre>
<p>　　5、依据下表修改对应的值：</p>
<table>
<thead>
<tr>
<th>宏</th>
<th>值</th>
</tr>
</thead>
<tbody>
<tr>
<td>MAGIC_NUMBER</td>
<td><code>total</code> 的地址</td>
</tr>
<tr>
<td>ADDR</td>
<td><code>last()</code> 的地址</td>
</tr>
<tr>
<td>OFFSET</td>
<td><code>57</code> 行 和<code>60</code> 行的汇编指令地址偏移量</td>
</tr>
</tbody>
</table>
<p>　　对于<code>OFFSET</code> ，其实就是找到<code>black_magic()</code> 调用之后的下一句和另一个分支的开始部分的指令地址偏移，假设反汇编后的关键部分如下：</p>
<pre><code>  400911:    e8 f0 fd ff ff           callq  400706 &lt;black_magic&gt;
  400916:    48 8b 15 8b 06 20 00     mov    0x20068b(%rip),%rdx        # 600fa8 &lt;people&gt;
  40091d:    8b 0d 8d 06 20 00        mov    0x20068d(%rip),%ecx        # 600fb0 &lt;total&gt;
  400923:    8b 05 77 06 20 00        mov    0x200677(%rip),%eax        # 600fa0 &lt;random_fd&gt;
  400929:    89 ce                    mov    %ecx,%esi
  40092b:    89 c7                    mov    %eax,%edi
  40092d:    e8 97 00 00 00           callq  4009c9 &lt;read_random&gt;
  400932:    89 05 80 06 20 00        mov    %eax,0x200680(%rip)        # 600fb8 &lt;last_dog&gt;
  400938:    b8 00 00 00 00           mov    $0x0,%eax
  40093d:    e8 f1 fd ff ff           callq  400733 &lt;last&gt;
  400942:    eb 6a                    jmp    4009ae &lt;main+0x226&gt;
  400944:    b8 b0 0f 60 00           mov    $0x600fb0,%eax
  400949:    8b 00                    mov    (%rax),%eax
  40094b:    d1 f8                    sar    %eax
</code></pre><p>　　那么，<code>OFFSET</code> 的值就是<code>0x400944</code>-<code>0x400916</code> ，也就是<code>46</code> 。</p>
<p>　　６、重新编译 <code>draw.c</code>.</p>
<pre><code class="sh">gcc -Wl,-z,norelro draw.c -o draw
</code></pre>
<p>　　如果不出意外，这样就可以运行了。</p>
<p>　　运行结果是：如果有<code>M</code>个人参加，那么编号为<code>M/2</code> 的人一定会中奖。 </p>
<h1 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h1><p>　　接下来，揭开这个黑魔法的面纱。</p>
<h2 id="x86、x64的堆栈结构"><a href="#x86、x64的堆栈结构" class="headerlink" title="x86、x64的堆栈结构"></a>x86、x64的堆栈结构</h2><p>　　这个部分是在<code>black_magic()</code> 函数上体现的。</p>
<p>　　根据程序的流程，应该是走的第一个<code>true</code> 分支，但是，在调用了<code>black_magic()</code> 这个函数后，会神奇地走到了另一个<code>false</code> 分支。</p>
<p>　　这个技巧是大三时，上<code>系统级程序设计</code> 时学会的，当时老师让我们通过改变输入的4个值，对一个程序的流程进行改变，从而解密出程序的结果。这个部分关键的地方就是——改变函数的<code>返回地址</code> 。而这个就需要对堆栈结构有一定的了解。</p>
<p>　　首先介绍<code>x86</code> 的堆栈结构（其实这里并不严谨，这些和操作系统、编译器都很相关，有很多不同的调用约定，这里就说明一下常见的<code>cdecl</code> ）：</p>
<ul>
<li>函数栈从高地址向低地址生长</li>
<li>函数调用时，函数参数逆序压栈</li>
<li>函数返回地址在函数参数的下面</li>
</ul>
<p>　　以上是一些关键的地方，具体的可以查看<a href="https://zh.wikipedia.org/wiki/X86%E8%B0%83%E7%94%A8%E7%BA%A6%E5%AE%9A" target="_blank" rel="noopener">X86调用约定</a> 。</p>
<p>　　所以，对于x86结构，函数返回地址在第一个函数参数的下面，如果需要修改返回地址，那么就需要取第一个函数参数的地址，然后减去一个字长，得到返回地址的地址，再去修改它。假设是x86平台，那么<code>black_magic()</code> 函数应该这么写：</p>
<pre><code class="c">void black_magic(int* incantation){
  *(((int*)&amp;incantation) - 1) += *incantation;
}
</code></pre>
<p>　　其中，<code>*incantation</code> 是我们要返回的地址和原先的返回地址（函数调用的下一条指令的地址）的偏移量。并且，因为返回地址是32位的，所以将<code>&amp;incantation</code> 转换为<code>int*</code> 。</p>
<p>　　而对于<code>x64</code> 平台，首先可以知道，寻址的范围增大到64位；通用寄存器增加到64位，并且为了向下兼容，可以对寄存器进行8位、16位、32位的寻址，这也是为什么64位兼容32位；函数参数的传递根据参数的个数可能是通过寄存器传值，也可能是通过栈传值……大概知道这些也差不多了，如果需要更进一步的了解，可以参考以下的博客：</p>
<ul>
<li><a href="http://papap.info/2017/03/14/Linux%E4%B8%8Bx64%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E5%92%8C%E5%A0%86%E6%A0%88/" target="_blank" rel="noopener">Linux下x64程序的函数调用和堆栈</a></li>
<li><a href="https://kelvinh.github.io/blog/2013/08/05/windows-x64-calling-conventions/" target="_blank" rel="noopener">Windows平台X64函数调用约定与汇编代码分析</a></li>
<li><a href="https://docs.microsoft.com/zh-cn/cpp/build/overview-of-x64-calling-conventions" target="_blank" rel="noopener">Overview of x64 Calling Conventions</a></li>
<li><a href="http://www.cnblogs.com/HsinTsao/p/6535138.html" target="_blank" rel="noopener">X86/X64 函数调用约定</a></li>
<li><a href="http://www.cnblogs.com/shines77/p/3788514.html" target="_blank" rel="noopener">Windows x64汇编函数调用约定</a></li>
<li><a href="http://www.jianshu.com/p/5a4f2d78cb53" target="_blank" rel="noopener">x64函数调用过程分析</a></li>
</ul>
<p>　　说了这么多，那么<code>x64</code> 平台要怎么做呢？很简单，返回地址在<code>rbp</code> 寄存器的上面，而第一个参数使用<code>rdi</code> 寄存器传递。</p>
<p>　　分析<code>black_magic()</code> 在<code>x64</code> 平台编译后的反汇编结果：</p>
<pre><code>0000000000400706 &lt;black_magic&gt;:
  400706:    55                       push   %rbp
  400707:    48 89 e5                 mov    %rsp,%rbp
  40070a:    48 89 7d f8              mov    %rdi,-0x8(%rbp)
  40070e:    48 8d 45 f8              lea    -0x8(%rbp),%rax
  400712:    48 83 c0 10              add    $0x10,%rax
  400716:    48 8d 55 f8              lea    -0x8(%rbp),%rdx
  40071a:    48 83 c2 10              add    $0x10,%rdx
  40071e:    48 8b 0a                 mov    (%rdx),%rcx
  400721:    48 8b 55 f8              mov    -0x8(%rbp),%rdx
  400725:    8b 12                    mov    (%rdx),%edx
  400727:    48 63 d2                 movslq %edx,%rdx
  40072a:    48 01 ca                 add    %rcx,%rdx
  40072d:    48 89 10                 mov    %rdx,(%rax)
  400730:    90                       nop
  400731:    5d                       pop    %rbp
  400732:    c3                       retq   
</code></pre><p>　　可以知道的是，在函数调用的开始，将<code>rbp</code> 寄存器压栈，将<code>rsp</code> 的值赋给<code>rbp</code> （标准的函数调用）。然后，关键的一步是，将<code>rdi</code> 寄存器的值（第一个参数）赋给<code>-0x8(%rbp)</code> ，也就是<code>rbp</code> 下面偏移一个字长。所以，综上所述，可以知道，要想获取函数的返回地址，需要获取第一个参数的地址，加上<code>1</code> 个字长得到<code>rbp</code> 的暂存地址，加上<code>2</code> 个字长得到函数返回地址。所以，假设是x64平台，那么<code>black_magic()</code> 函数应该这么写（也是我采用的）：</p>
<pre><code class="c">void black_magic(int* incantation){
  *(((long*)&amp;incantation) + 2) += *incantation;
}
</code></pre>
<p>　　同样的，<code>*incantation</code> 是我们要返回的地址和原先的返回地址（函数调用的下一条指令的地址）的偏移量。并且，因为返回地址是64位，所以将<code>&amp;incantation</code> 转换为<code>long*</code> 。</p>
<h2 id="终止节与格式化字符串攻击"><a href="#终止节与格式化字符串攻击" class="headerlink" title="终止节与格式化字符串攻击"></a>终止节与格式化字符串攻击</h2><p>　　这个部分我不太想赘述，在我的另一篇博客<a href="http://w-angler.com/2016/12/05/%E7%94%A8%E4%B8%80%E4%B8%AAprintf-%E8%AF%AD%E5%8F%A5%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AAweb%E6%9C%8D%E5%8A%A1%E5%99%A8/">用一个printf()语句实现一个web服务器</a>中有完整的描述。</p>
<h2 id="整体的流程"><a href="#整体的流程" class="headerlink" title="整体的流程"></a>整体的流程</h2><ol>
<li>使用Linux内核提供的真随机数发生器；</li>
<li>随机获取前N-1个获奖者；</li>
<li>假装是随机获取最后一个，但是，调用<code>black_magic()</code> 函数后，跳转到另一个分支中；</li>
<li>执行预先设计好的格式化字符串攻击代码，修改<code>last_dog</code> 的值，并且修改<code>终止节</code> ，使得在程序退出时，调用<code>last()</code> 函数；</li>
<li>非(yi)常(dian)非(ye)常(bu)意外地，第<code>M/2</code> 个人获奖了。</li>
</ol>
<h2 id="黑魔法的破灭"><a href="#黑魔法的破灭" class="headerlink" title="黑魔法的破灭"></a>黑魔法的破灭</h2><p>　　其实要破坏这个所谓的黑魔法，非常简单：</p>
<ul>
<li>换成32位系统（堆栈结构不一样）</li>
<li>换成windows（堆栈结构、终止节都不同）</li>
<li>使用低版本的gcc或者其他编译器（终止节不一样）</li>
</ul>
<h4 id="写在最后"><a href="#写在最后" class="headerlink" title="写在最后"></a>写在最后</h4><p>　　其实说实话这个并不是什么特别高深的东西，只是因为大家了解的层面不一样，所以可能会看不太懂。</p>
<p>　　这个实现有以下几个致命缺点：</p>
<ul>
<li>依赖于linux系统的ELF文件的格式</li>
<li>依赖于x86或者x64的堆栈结构</li>
<li>并不能做到完全的信息隐藏</li>
</ul>
<p>　　当时老师也指出了，这个代码只要多看几眼，就会发现问题的所在。</p>
<p>　　那节课展示的同学中，看到有利用缓冲区溢出的、修改python标准库源码的、利用自然数据的不均匀性的，以及各种代码技巧、数学方法，还是非常大开眼界的，这种开脑洞的东西确实还是非常有意思。</p>
<p>　　Anyway… Stay hungry. Stay foolish.</p>

        
    

    
</div>


                

                <!-- Post Comments -->
                
                    
    <!-- 使用 gitcoment -->
<div id="gitment-comment">
    <!-- Gitment 评论框 -->
<div id="container"></div>
</div>
<style>
    #gitment-comment{
        background-color: #eee;
        padding: 2pc;
    }
</style>
<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
<script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
<script>
    var gitment = new Gitment({
        id: 'https://w-angler.com/2017/09/21/函数堆栈、格式化字符串攻击以及抽奖作弊/', // 可选。默认为 location.href
        owner: 'W-angler',
        repo: 'w-angler.github.io',
        oauth: {
            client_id: 'a3a3061c655fee6007da',
            client_secret: 'bc80f0e67bf63ff206c2efee14d8c76eb7a53472',
        },
    })
    gitment.render('container')
</script>


                
            </div>

            <!-- Post Prev & Next Nav -->
            <nav class="material-nav mdl-color-text--grey-50 mdl-cell mdl-cell--12-col">
    <!-- Prev Nav -->
    
        <a href="/2017/12/06/基于栈的虚拟机的实现/" id="post_nav-newer" class="prev-content">
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_back</i>
            </button>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            新篇
        </a>
    

    <!-- Section Spacer -->
    <div class="section-spacer"></div>

    <!-- Next Nav -->
    
        <a href="/2017/02/13/ubuntu下git服务器搭建/" id="post_nav-older" class="next-content">
            旧篇
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_forward</i>
            </button>
        </a>
    
</nav>

        </div>
    </div>



                    
                        <!-- Overlay For Active Sidebar -->
<div class="sidebar-overlay"></div>

<!-- Material sidebar -->
<aside id="sidebar" class="sidebar sidebar-colored sidebar-fixed-left" role="navigation">
    <div id="sidebar-main">
        <!-- Sidebar Header -->
        <div class="sidebar-header header-cover" style="background-image: url(/img/sidebar_header.png);">
    <!-- Top bar -->
    <div class="top-bar"></div>

    <!-- Sidebar toggle button -->
    <button type="button" class="sidebar-toggle mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" style="display: initial;" data-upgraded=",MaterialButton,MaterialRipple">
        <i class="material-icons">clear_all</i>
        <span class="mdl-button__ripple-container">
            <span class="mdl-ripple">
            </span>
        </span>
    </button>

    <!-- Sidebar Avatar -->
    <div class="sidebar-image">
        <img src="/img/avatar.jpg" alt="W-angler's avatar">
    </div>

    <!-- Sidebar Email -->
    <a data-toggle="dropdown" class="sidebar-brand" href="#settings-dropdown">
        wangler0408@gmail.com
        <b class="caret"></b>
    </a>
</div>


        <!-- Sidebar Navigation  -->
        <ul class="nav sidebar-nav">
    <!-- User dropdown  -->
    <li class="dropdown">
        <ul id="settings-dropdown" class="dropdown-menu">
            
                <li>
                    <a href="mailto:wangler0408@gmail.com" target="_blank" title="与我联系">
                        
                            <i class="material-icons sidebar-material-icons sidebar-indent-left1pc-element">email</i>
                        
                        与我联系
                    </a>
                </li>
            
                <li>
                    <a href="https://github.com/W-angler" target="_blank" title="github">
                        
                            <i class="material-icons sidebar-material-icons sidebar-indent-left1pc-element">code</i>
                        
                        github
                    </a>
                </li>
            
                <li>
                    <a href="/atom.xml" target="_blank" title="RSS">
                        
                            <i class="material-icons sidebar-material-icons sidebar-indent-left1pc-element">rss_feed</i>
                        
                        RSS
                    </a>
                </li>
            
        </ul>
    </li>

    <!-- Homepage -->
    
        <li id="sidebar-first-li">
            <a href="/">
                
                    <i class="material-icons sidebar-material-icons">home</i>
                
                主页
            </a>
        </li>
        
    

    <!-- Archives  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">inbox</i>
                
                    归档
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
            <li>
                <a class="sidebar_archives-link" href="/archives/2018/09/">九月 2018<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/12/">十二月 2017<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/09/">九月 2017<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/02/">二月 2017<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/12/">十二月 2016<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/11/">十一月 2016<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/10/">十月 2016<span class="sidebar_archives-count">8</span></a>
            </li></ul>
        </li>
        
    

    <!-- Categories  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">chrome_reader_mode</i>
                
                分类
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
                <li>
                <a class="sidebar_archives-link" href="/categories/Antlr/">Antlr<span class="sidebar_archives-count">5</span></a></li><li><a class="sidebar_archives-link" href="/categories/JVM/">JVM<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/categories/PLT/">PLT<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/categories/git/">git<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/categories/奇技淫巧/">奇技淫巧<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/categories/科研/">科研<span class="sidebar_archives-count">1</span></a>
            </li></ul>
        </li>
        
            <li class="divider"></li>
        
    

    <!-- Pages  -->
    
        <li>
            <a href="/atom.xml" title="RSS">
                
                    <i class="material-icons sidebar-material-icons">rss_feed</i>
                
                RSS
            </a>
        </li>
        
    
        <li>
            <a href="/tags" title="标签">
                
                    <i class="material-icons sidebar-material-icons">bookmark</i>
                
                标签
            </a>
        </li>
        
    
        <li>
            <a href="/timeline" title="时间轴">
                
                    <i class="material-icons sidebar-material-icons">timeline</i>
                
                时间轴
            </a>
        </li>
        
    
        <li>
            <a href="/gallery" title="相册">
                
                    <i class="material-icons sidebar-material-icons">collections</i>
                
                相册
            </a>
        </li>
        
    
        <li>
            <a href="/links" title="友情链接">
                
                    <i class="material-icons sidebar-material-icons">link</i>
                
                友情链接
            </a>
        </li>
        
    
        <li>
            <a href="/about" title="关于">
                
                    <i class="material-icons sidebar-material-icons">person</i>
                
                关于
            </a>
        </li>
        
            <li class="divider"></li>
        
    

    <!-- Article Number  -->
    
        <li>
            <a href="/archives">
                文章总数
                <span class="sidebar-badge">14</span>
            </a>
        </li>
        
    
</ul>


        <!-- Sidebar Footer -->
        <!--
I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright, I will thank you so much.
If you still want to delete the copyrights, could you still retain the first one? Which namely "Theme Material"
It will not impact the appearance and can give developers a lot of support :)

很高兴您使用并喜欢该主题，开发不易 十分谢谢与希望您可以保留一下版权声明。
如果您仍然想删除的话 能否只保留第一项呢？即 "Theme Material"
它不会影响美观并可以给开发者很大的支持和动力。 :)
-->

<!-- Sidebar Divider -->


<!-- Theme Material -->


<!-- Help & Support -->
<!--

-->

<!-- Feedback -->
<!--

-->

<!-- About Theme -->
<!--

-->

    </div>

    <!-- Sidebar Image -->
    

</aside>

                    

                    
                        <!-- Footer Top Button -->
                        <div id="back-to-top" class="toTop-wrap">
    <a href="#top" class="toTop">
        <i class="material-icons footer_top-i">expand_less</i>
    </a>
</div>

                    

                    <!--Footer-->
<footer class="mdl-mini-footer" id="bottom">
    
        <!-- Paradox Footer Left Section -->
        <div class="mdl-mini-footer--left-section sns-list">
    <!-- Twitter -->
    
        <a href="https://twitter.com/wangler0408" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-twitter">
                <span class="visuallyhidden">Twitter</span>
            </button><!--
     --></a>
    

    <!-- Facebook -->
    

    <!-- Google + -->
    
        <a href="https://plus.google.com/101029110222735975086" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-gplus">
                <span class="visuallyhidden">Google Plus</span>
            </button><!--
     --></a>
    

    <!-- Weibo -->
    

    <!-- Instagram -->
    

    <!-- Tumblr -->
    

    <!-- Github -->
    
        <a href="https://github.com/W-angler" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-github">
                <span class="visuallyhidden">Github</span>
            </button><!--
     --></a>
    

    <!-- LinkedIn -->
    
        <a href="https://cn.linkedin.com/in/%E9%B9%8F%E7%A8%8B-%E6%B1%AA-6332a5121" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-linkedin">
                <span class="visuallyhidden">LinkedIn</span>
            </button><!--
     --></a>
    

    <!-- Zhihu -->
    

    <!-- Bilibili -->
    

    <!-- Telegram -->
    

    <!-- V2EX -->
    

    <!-- Segmentfault -->
    
</div>


        <!--Copyright-->
        <div id="copyright">
            Copyright&nbsp;©&nbsp;<span year=""></span>&nbsp;年轻人啊不要熬夜
            
        </div>

        <!-- Paradox Footer Right Section -->

        <!--
        I am glad you use this theme, the development is no so easy, I hope you can keep the copyright.
        It will not impact the appearance and can give developers a lot of support :)

        很高兴您使用该主题，开发不易，希望您可以保留一下版权声明。
        它不会影响美观并可以给开发者很大的支持。 :)
        -->

        <div class="mdl-mini-footer--right-section">
            <div>
                <div class="footer-develop-div">Powered by <a href="https://hexo.io" target="_blank" class="footer-develop-a">Hexo</a></div>
                <div class="footer-develop-div">Theme - <a href="https://github.com/viosey/hexo-theme-material" target="_blank" class="footer-develop-a">Material</a></div>
            </div>
        </div>
    
</footer>


                    <!-- Import JS File -->

    <script>lsloader.load("lazyload_js","https://cdn.jsdelivr.net/gh/viosey/hexo-theme-material@1.5.6/source//js/lazyload.min.js", true)</script>



    <script>lsloader.load("js_js","https://cdn.jsdelivr.net/gh/viosey/hexo-theme-material@1.5.6/source//js/js.min.js", true)</script>



    <script>lsloader.load("np_js","https://cdn.bootcss.com/nprogress/0.2.0/nprogress.min.js", true)</script>


<script type="text/ls-javascript" id="NProgress-script">
    NProgress.configure({
        showSpinner: true
    });
    NProgress.start();
    $('#nprogress .bar').css({
        'background': '#29d'
    });
    $('#nprogress .peg').css({
        'box-shadow': '0 0 10px #29d, 0 0 15px #29d'
    });
    $('#nprogress .spinner-icon').css({
        'border-top-color': '#29d',
        'border-left-color': '#29d'
    });
    setTimeout(function() {
        NProgress.done();
        $('.fade').removeClass('out');
    }, 800);
</script>



    
        <script>lsloader.load("sm_js","https://cdn.jsdelivr.net/gh/viosey/hexo-theme-material@1.5.6/source//js/smoothscroll.js", true)</script>
    







   <!-- Gitment -->





<!-- UC Browser Compatible -->
<script>
	var agent = navigator.userAgent.toLowerCase();
	if(agent.indexOf('ucbrowser')>0) {
		document.write('<link rel="stylesheet" href="/css/uc.css">');
	   alert('由于 UC 浏览器使用极旧的内核，而本网站使用了一些新的特性。\n为了您能更好的浏览，推荐使用 Chrome 或 Firefox 浏览器。');
	}
</script>

<!-- Import prettify js  -->

    
        
            <script>lsloader.load("prettify_js","https://cdn.bootcss.com/prettify/r298/prettify.min.js", true)</script>
        
    



<!-- Window Load -->
<!-- add class for prettify -->
<script type="text/ls-javascript" id="window-load">
    $(window).on('load', function() {
        // Post_Toc parent position fixed
        $('.post-toc-wrap').parent('.mdl-menu__container').css('position', 'fixed');
    });

    
        
            $(function() {
                $('pre').addClass('prettyprint linenums').attr('style', 'overflow:auto;');
                prettyPrint();
                })
        
    
    
</script>

<!-- MathJax Load-->


<!-- Bing Background -->


<script type="text/ls-javascript" id="lazy-load">
    // Offer LazyLoad
    queue.offer(function(){
        $('.lazy').lazyload({
            effect : 'show'
        });
    });

    // Start Queue
    $(document).ready(function(){
        setInterval(function(){
            queue.execNext();
        },200);
    });
</script>

<!-- Custom Footer -->



<script>
    var copyrightNow = new Date().getFullYear();
    var textContent = document.querySelector('span[year]')

    copyrightSince = 2016;
    if (copyrightSince === copyrightNow||copyrightSince === 0000) {
        textContent.textContent = copyrightNow
    } else {
        textContent.textContent = copyrightSince + ' - ' + copyrightNow
    }

    (function(){
        var scriptList = document.querySelectorAll('script[type="text/ls-javascript"]')

        for (var i = 0; i < scriptList.length; ++i) {
            var item = scriptList[i];
            lsloader.runInlineScript(item.id,item.id);
        }
    })()
console.log('\n %c © Material Theme | Version: 1.5.6 | https://github.com/viosey/hexo-theme-material %c \n', 'color:#455a64;background:#e0e0e0;padding:5px 0;border-top-left-radius:5px;border-bottom-left-radius:5px;', 'color:#455a64;background:#e0e0e0;padding:5px 0;border-top-right-radius:5px;border-bottom-right-radius:5px;');
</script>

                </main>
            </div>
        </body>
    
</html>
